<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Personal Finance ‚Äî BK</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --accent-h: 200;
    --accent: hsl(var(--accent-h) 87% 42%);
    --accent-2: hsl(calc(var(--accent-h)+12) 87% 52%);
    --ink: #0e1624;
    --muted:#6c7a90;
    --line:#e8ecf3;
    --surface:#ffffffcc;
    --surface-2:#f7f9fc;
    --radius:14px;
    --shadow-sm:0 6px 20px rgba(16,24,40,.06);
    --shadow-lg:0 20px 60px rgba(16,24,40,.10);
    --nav-h:64px;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --ink:#eaf1ff; --muted:#9fb2c8; --line:#1e2a3c;
      --surface:#131b27cc; --surface-2:#0f1724;
      --shadow-sm:0 8px 30px rgba(0,0,0,.45);
      --shadow-lg:0 28px 80px rgba(0,0,0,.55);
    }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    color:var(--ink); background:
      radial-gradient(1200px 600px at 10% -10%, hsl(var(--accent-h) 90% 85% / .35), transparent 60%),
      radial-gradient(900px 520px at 110% 0%, hsl(calc(var(--accent-h)+40) 90% 80% / .25), transparent 60%),
      linear-gradient(#f6f8fb, #eef2f8);
    background-attachment: fixed;
  }
  .sheet{max-width:1180px; margin:14px auto; padding:14px}
  .top{
    display:flex; align-items:center; justify-content:space-between;
    background:var(--surface); backdrop-filter: blur(10px);
    border:1px solid var(--line); border-radius:20px; padding:12px 14px; box-shadow:var(--shadow-sm);
  }
  .brand{display:flex; align-items:center; gap:10px}
  .monogram{
    width:40px; height:40px; border-radius:12px; display:grid; place-items:center;
    color:#fff; font-weight:800; letter-spacing:.5px;
    background:linear-gradient(135deg, var(--accent), var(--accent-2));
    box-shadow:0 10px 28px hsl(var(--accent-h) 87% 42% / .35);
  }
  .title{font-weight:800; letter-spacing:.2px}
  .tools{display:flex; align-items:center; gap:8px}
  .chip{
    width:24px; height:24px; border-radius:999px; border:1px solid var(--line); cursor:pointer; box-shadow:var(--shadow-sm)
  }
  .chip[data-h="200"]{background:hsl(200 87% 42%)}
  .chip[data-h="265"]{background:hsl(265 87% 52%)}
  .chip[data-h="15"] {background:hsl(15 87% 52%)}
  .chip[data-h="95"] {background:hsl(95 87% 40%)}

  .layout{display:grid; grid-template-columns: 1fr; gap:16px; margin-top:12px}
  @media (min-width: 980px){ .layout{grid-template-columns:220px 1fr} }

  /* Nav (sidebar on desktop, bottom on mobile) */
  .nav{
    position:sticky; top:14px; background:var(--surface); border:1px solid var(--line);
    border-radius:16px; box-shadow:var(--shadow-sm); padding:8px; height:max-content;
  }
  .tab{
    display:flex; align-items:center; gap:10px; padding:10px 12px; text-decoration:none; color:var(--muted);
    border-radius:12px; font-weight:700;
  }
  .tab + .tab{margin-top:6px}
  .tab.active{color:var(--ink); background:linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.04))}
  .tab .dot{
    width:8px; height:8px; border-radius:999px; background:var(--line);
  }
  .tab.active .dot{
    background:linear-gradient(135deg, var(--accent), var(--accent-2));
    box-shadow:0 0 0 4px hsl(var(--accent-h) 90% 45% / .18);
  }

  @media (max-width: 979px){
    .nav{
      position:fixed; left:50%; transform:translateX(-50%); bottom:12px; width:min(96%, 640px);
      display:flex; gap:8px; padding:8px; z-index:20;
    }
    .tab{justify-content:center; flex:1}
    .tab + .tab{margin-top:0}
  }

  /* Cards, sections */
  .card{
    background:var(--surface); border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow-sm);
  }
  section.view{display:none}
  section.view.active{display:block}
  .section-head{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--line)}
  h1{margin:0; font-size:1.25rem}
  h2{margin:0; font-size:.95rem; color:var(--muted); font-weight:600; letter-spacing:.2px}

  .pad{padding:16px}
  .grid-wallets{display:grid; gap:12px; grid-template-columns:repeat(auto-fit, minmax(180px,1fr))}
  .wallet{
    padding:14px; border-radius:14px; border:1px solid var(--line);
    background:linear-gradient(180deg, rgba(255,255,255,.30), rgba(255,255,255,.14));
    transition: transform .12s, box-shadow .12s;
  }
  .wallet:hover{transform:translateY(-2px); box-shadow:var(--shadow-lg)}
  .wallet h4{margin:0 0 4px; font-size:.95rem; font-weight:700}
  .wallet p{margin:0; font-size:1.15rem; font-weight:800; color:var(--accent)}

  .summary{display:grid; gap:12px; grid-template-columns:repeat(auto-fit, minmax(200px,1fr))}
  .sum{
    padding:14px; border-radius:14px; border:1px solid var(--line);
    background:linear-gradient(180deg, rgba(255,255,255,.20), rgba(255,255,255,.08));
  }
  .sum h3{margin:0 0 4px; font-size:.85rem; color:var(--muted)}
  .sum p{margin:0; font-size:1.1rem; font-weight:800}
  .i{--col:#16a34a} .e{--col:#ef4444} .l{--col:#f59e0b} .b{--col:#06b6d4} .n{--col:#7c3aed} .sv{--col:#0ea5e9}
  .sum p{color:var(--col)}

  .charts{display:grid; gap:12px; grid-template-columns:1fr 1fr}
  @media (max-width:900px){ .charts{grid-template-columns:1fr} }
  .chart-card{padding:14px}

  /* Form controls */
  .form{display:grid; gap:12px; padding:14px}
  .fg{display:grid; gap:6px}
  label{font-weight:700; font-size:.9rem}
  input, select, button{
    font-family:inherit; font-size:1rem;
  }
  input, select{
    padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:var(--surface-2); color:inherit; outline:none;
    transition:border-color .15s, box-shadow .15s;
  }
  input:focus, select:focus{border-color:var(--accent); box-shadow:0 0 0 4px hsl(var(--accent-h) 90% 45% / .18)}
  .row{display:flex; gap:10px; flex-wrap:wrap}

  .btn{
    border:none; border-radius:12px; padding:10px 14px; font-weight:800; letter-spacing:.2px; color:#fff; cursor:pointer;
    background:linear-gradient(135deg, var(--accent), var(--accent-2));
    box-shadow:0 10px 28px hsl(var(--accent-h) 90% 45% / .28);
  }
  .btn-ghost{background:transparent; color:var(--ink); border:1px solid var(--line)}
  .btn-danger{background:linear-gradient(135deg, #ef4444, #b91c1c)}
  .btn-success{background:linear-gradient(135deg, #16a34a, #0f7a34)}
  .btn.small{padding:6px 10px; font-size:.9rem}

  /* History list */
  .list{list-style:none; margin:0; padding:0}
  .item{padding:12px 14px; border-top:1px solid var(--line)}
  .item:first-child{border-top:0}
  .topline{display:flex; align-items:center; justify-content:space-between; gap:10px}
  .meta{margin-top:4px; color:var(--muted); font-size:.9rem}
  .amt{font-weight:900}
  .amt.in{color:#16a34a} .amt.ex{color:#ef4444} .amt.tr{color:#06b6d4} .amt.as{color:#f59e0b} .amt.li{color:var(--accent)}

  /* Category chips */
  .chip-type{
    padding:4px 8px; border-radius:999px; border:1px solid var(--line); font-size:.8rem; color:var(--muted); background:var(--surface-2)
  }
  .group{padding:10px 14px; border-top:1px solid var(--line)}
  .group:first-child{border-top:0}
  .subrow{display:flex; align-items:center; justify-content:space-between; padding:8px 0; border-top:1px dashed var(--line)}
  .subrow:first-child{border-top:0}

  /* Modals */
  .modal{display:none; position:fixed; inset:0; background:rgba(10,16,28,.4); backdrop-filter: blur(2px); z-index:40; align-items:center; justify-content:center}
  .modal.show{display:flex}
  .modal-card{width:92%; max-width:560px}
  .modal-head{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--line)}
  .modal-body{padding:14px}
  .modal-foot{padding:0 14px 14px; display:flex; gap:10px; justify-content:flex-end}
  .close{font-size:26px; color:var(--muted); cursor:pointer}

  /* Toast */
  .toast{
    position:fixed; right:16px; bottom:16px; z-index:60; opacity:0; transform:translateY(6px);
    background:#101827; color:#fff; border-radius:12px; padding:10px 12px; font-weight:800; letter-spacing:.2px;
    transition:opacity .2s, transform .2s;
  }
  .toast.show{opacity:1; transform:translateY(0)}
</style>
</head>
<body>
  <div class="sheet">
    <header class="top">
      <div class="brand">
        <div class="monogram">BK</div>
        <div class="title">Personal Finance</div>
      </div>
      <div class="tools" title="Accent">
        <div class="chip" data-h="200" aria-label="Teal"></div>
        <div class="chip" data-h="265" aria-label="Purple"></div>
        <div class="chip" data-h="15"  aria-label="Coral"></div>
        <div class="chip" data-h="95"  aria-label="Lime"></div>
      </div>
    </header>

    <div class="layout">
      <!-- NAV -->
      <nav class="nav card">
        <a class="tab active" href="#" data-target="v-home"><span class="dot"></span> Wallets</a>
        <a class="tab" href="#" data-target="v-add"><span class="dot"></span> Add</a>
        <a class="tab" href="#" data-target="v-history"><span class="dot"></span> History</a>
        <a class="tab" href="#" data-target="v-categories"><span class="dot"></span> Categories</a>
      </nav>

      <!-- MAIN -->
      <main>
        <!-- HOME -->
        <section id="v-home" class="view active card">
          <div class="section-head">
            <h1>Overview</h1>
            <h2>At a glance</h2>
          </div>
          <div class="pad">
            <h2>Wallets</h2>
            <div id="walletsGrid" class="grid-wallets"></div>

            <h2 style="margin-top:14px">Summary</h2>
            <div class="summary" id="summary">
              <div class="sum i"><h3>Total Income</h3><p id="totalIncome">‡ß≥0.00</p></div>
              <div class="sum e"><h3>Total Expense</h3><p id="totalExpense">‡ß≥0.00</p></div>
              <div class="sum l"><h3>Total Lent</h3><p id="totalLent">‡ß≥0.00</p></div>
              <div class="sum b"><h3>Total Borrowed</h3><p id="totalBorrowed">‡ß≥0.00</p></div>
              <div class="sum n"><h3>Net Worth</h3><p id="netWorth">‡ß≥0.00</p></div>
              <div class="sum sv"><h3>Total Savings</h3><p id="totalSavings">‡ß≥0.00</p></div>
            </div>

            <h2 style="margin-top:14px">Analytics</h2>
            <div class="charts">
              <div class="card chart-card"><canvas id="expensePieChart"></canvas></div>
              <div class="card chart-card"><canvas id="incomeExpenseBarChart"></canvas></div>
            </div>
          </div>
        </section>

        <!-- ADD -->
        <section id="v-add" class="view card">
          <div class="section-head"><h1>Add Transaction</h1><h2>Record a new entry</h2></div>
          <form id="trackerForm" class="form">
            <div class="fg"><label for="description">Description</label><input id="description" type="text" placeholder="e.g., Weekly Groceries" required></div>
            <div class="row" style="width:100%">
              <div class="fg" style="flex:1 1 180px"><label for="amount">Amount (‡ß≥)</label><input id="amount" type="number" step="0.01" min="0.01" placeholder="0.00" required></div>
              <div class="fg" style="flex:1 1 180px"><label for="transactionDate">Date</label><input id="transactionDate" type="date" required></div>
              <div class="fg" style="flex:1 1 180px"><label for="wallet">Wallet</label><select id="wallet" required></select></div>
            </div>
            <div class="row">
              <div class="fg" style="flex:1 1 240px"><label for="category">Category</label><select id="category" required></select></div>
              <div class="fg" style="flex:1 1 240px"><label for="subcategory">Subcategory</label><select id="subcategory" required></select></div>
            </div>
            <div id="transferFields" class="row" style="display:none">
              <div class="fg" style="flex:1 1 240px"><label for="toWallet">To Wallet</label><select id="toWallet"></select></div>
            </div>
            <div class="row">
              <button type="submit" class="btn">Add Transaction</button>
            </div>
          </form>
        </section>

        <!-- HISTORY -->
        <section id="v-history" class="view card">
          <div class="section-head"><h1>Transaction History</h1><h2>Filter & export</h2></div>
          <div class="pad">
            <div class="row" style="align-items:flex-end">
              <div class="fg" style="flex:1 1 260px"><label for="categorySearch">Filter by Category</label><select id="categorySearch"><option value="all">All Categories</option></select></div>
              <button id="downloadCsvBtn" class="btn btn-success">üì• Download CSV</button>
            </div>
            <ul id="transactionList" class="list" style="margin-top:10px"></ul>
          </div>
        </section>

        <!-- CATEGORIES -->
        <section id="v-categories" class="view card">
          <div class="section-head"><h1>Manage Categories</h1><h2>Organize by type</h2></div>
          <div class="pad">
            <div class="card" style="padding:14px; margin-bottom:12px">
              <h2 style="margin-bottom:10px">Add New Category</h2>
              <div class="row">
                <input id="newCategoryName" type="text" placeholder="e.g., Business" style="flex:2 1 260px">
                <select id="newCategoryType" style="flex:1 1 200px">
                  <option value="income">Income</option>
                  <option value="expense">Expense</option>
                  <option value="asset">Lent Money (Asset)</option>
                  <option value="liability">Borrowed Money (Liability)</option>
                  <option value="transfer">Transfer</option>
                </select>
                <button id="addCategoryBtn" type="button" class="btn small">‚ûï Add</button>
              </div>
            </div>

            <div class="card" style="padding:14px; margin-bottom:12px">
              <h2 style="margin-bottom:10px">Backup & Restore</h2>
              <div class="row">
                <button id="backupBtn" type="button" class="btn btn-success">‚¨ÜÔ∏è Backup to Drive</button>
                <button id="listBackupsBtn" type="button" class="btn">üìÑ List Backups</button>
              </div>
              <div id="restoreSection" style="display:none; margin-top:10px">
                <div class="row">
                  <select id="restoreFileSelect" style="flex:1 1 360px">
                    <option value="">-- Select a backup --</option>
                  </select>
                  <button id="restoreBtn" type="button" class="btn btn-danger" disabled>‚¨áÔ∏è Restore Selected</button>
                </div>
              </div>
            </div>

            <!-- Grouped by type -->
            <div id="categoryGroups" class="card">
              <div class="section-head"><h2 style="color:var(--ink)">Categories</h2><span class="chip-type">Grouped by Type</span></div>
              <div id="categoryList" class="pad"></div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Modals -->
  <div id="editModal" class="modal">
    <div class="modal-card card">
      <div class="modal-head"><h1>Edit Transaction</h1><span class="close" data-target="editModal">&times;</span></div>
      <form id="editForm" class="modal-body form">
        <input type="hidden" id="editId">
        <div class="fg"><label for="editDescription">Description</label><input id="editDescription" required></div>
        <div class="row">
          <div class="fg" style="flex:1 1 180px"><label for="editAmount">Amount (‡ß≥)</label><input id="editAmount" type="number" step="0.01" min="0.01" required></div>
          <div class="fg" style="flex:1 1 180px"><label for="editTransactionDate">Date</label><input id="editTransactionDate" type="date" required></div>
        </div>
        <div class="row">
          <div class="fg" style="flex:1 1 200px"><label for="editWallet">Wallet</label><select id="editWallet" required></select></div>
          <div class="fg" style="flex:1 1 200px"><label for="editCategory">Category</label><select id="editCategory" required></select></div>
          <div class="fg" style="flex:1 1 200px"><label for="editSubcategory">Subcategory</label><select id="editSubcategory" required></select></div>
        </div>
        <div id="editTransferFields" class="row" style="display:none">
          <div class="fg" style="flex:1 1 240px"><label for="editToWallet">To Wallet</label><select id="editToWallet"></select></div>
        </div>
        <div class="modal-foot">
          <button type="button" class="btn btn-ghost" data-target="editModal">Cancel</button>
          <button type="submit" class="btn">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <div id="addSubcategoryModal" class="modal">
    <div class="modal-card card">
      <div class="modal-head"><h1>Add Subcategory</h1><span class="close" data-target="addSubcategoryModal">&times;</span></div>
      <div class="modal-body form">
        <div class="fg"><label for="newSubcategoryName">Name</label><input id="newSubcategoryName" placeholder="e.g., Office Supplies"></div>
      </div>
      <div class="modal-foot">
        <button type="button" class="btn btn-ghost" data-target="addSubcategoryModal">Close</button>
        <button type="button" id="saveSubcategoryBtn" class="btn">Save</button>
      </div>
    </div>
  </div>

  <div id="editCategoryModal" class="modal">
    <div class="modal-card card">
      <div class="modal-head"><h1>Edit Category</h1><span class="close" data-target="editCategoryModal">&times;</span></div>
      <div class="modal-body form">
        <input type="hidden" id="editCategoryId">
        <div class="fg"><label for="editCategoryName">Category Name</label><input id="editCategoryName" required></div>
        <div class="fg"><label for="editCategoryType">Type</label>
          <select id="editCategoryType">
            <option value="income">Income</option>
            <option value="expense">Expense</option>
            <option value="asset">Lent Money (Asset)</option>
            <option value="liability">Borrowed Money (Liability)</option>
            <option value="transfer">Transfer</option>
          </select>
        </div>
      </div>
      <div class="modal-foot">
        <button type="button" class="btn btn-ghost" data-target="editCategoryModal">Close</button>
        <button type="button" id="saveCategoryChangesBtn" class="btn">Save Changes</button>
      </div>
    </div>
  </div>

  <div id="editSubcategoryModal" class="modal">
    <div class="modal-card card">
      <div class="modal-head"><h1>Edit Subcategory</h1><span class="close" data-target="editSubcategoryModal">&times;</span></div>
      <div class="modal-body form">
        <input type="hidden" id="editSubcategoryId">
        <div class="fg"><label for="editSubcategoryName">Subcategory Name</label><input id="editSubcategoryName" required></div>
      </div>
      <div class="modal-foot">
        <button type="button" class="btn btn-ghost" data-target="editSubcategoryModal">Close</button>
        <button type="button" id="saveSubcategoryChangesBtn" class="btn">Save Changes</button>
      </div>
    </div>
  </div>

  <div id="deleteConfirmModal" class="modal">
    <div class="modal-card card">
      <div class="modal-head"><h1>Confirm Deletion</h1><span class="close" data-target="deleteConfirmModal">&times;</span></div>
      <div class="modal-body"><p id="deleteConfirmMessage" style="margin:0">Are you sure?</p></div>
      <div class="modal-foot">
        <button type="button" class="btn btn-ghost" data-target="deleteConfirmModal">Cancel</button>
        <button type="button" id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  /* CONFIG */
  const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyWPsjs0tYMKTp6CMZ8XhKboYRvqROTvBDLn8cTaOgqxsW-5rev-CSajbrIYpVKLJU/exec';

  /* Shortcuts */
  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);

  /* Accent chooser */
  $$('.chip').forEach(el=>{
    el.addEventListener('click', ()=>{
      document.documentElement.style.setProperty('--accent-h', el.dataset.h);
    });
  });

  /* Toast */
  const toast = $('#toast');
  const showToast = (msg) => { toast.textContent = msg; toast.classList.add('show'); setTimeout(()=> toast.classList.remove('show'), 2000); };

  /* Nav */
  const tabs = $$('.tab'), views = $$('.view');
  const switchView = id => {
    views.forEach(v=>v.classList.remove('active'));
    tabs.forEach(t=>t.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelector(`.tab[data-target="${id}"]`).classList.add('active');
  };
  tabs.forEach(t=> t.addEventListener('click', e=>{ e.preventDefault(); switchView(t.getAttribute('data-target')); }));

  /* Elements */
  const walletsGrid = $('#walletsGrid');
  const transactionList = $('#transactionList');
  const form = $('#trackerForm'); const editForm = $('#editForm');

  const categoryListEl = $('#categoryList'); const categoryGroups = $('#categoryGroups');
  const categorySelect = $('#category'); const subcategorySelect = $('#subcategory');
  const walletSelect = $('#wallet'); const toWalletSelect = $('#toWallet'); const transferFields = $('#transferFields');

  const editCategorySelect = $('#editCategory'); const editSubcategorySelect = $('#editSubcategory');
  const editWalletSelect = $('#editWallet'); const editToWalletSelect = $('#editToWallet'); const editTransferFields = $('#editTransferFields');

  const categorySearchSelect = $('#categorySearch'); const downloadCsvBtn = $('#downloadCsvBtn');

  const backupBtn = $('#backupBtn'); const listBackupsBtn = $('#listBackupsBtn');
  const restoreSection = $('#restoreSection'); const restoreFileSelect = $('#restoreFileSelect'); const restoreBtn = $('#restoreBtn');

  /* Data */
  const defaultCategories = [
    { id: 1, name: 'Accounts / Wallets', type: 'transfer' },
    { id: 2, name: 'Savings / Investments', type: 'expense' },
    { id: 3, name: 'Expense', type: 'expense' },
    { id: 4, name: 'Income', type: 'income' },
    { id: 5, name: 'Lending / Borrowing', type: 'asset' }
  ];
  const defaultSubcategories = [
    { id: 1, name: 'Bank ‚Üí bKash', categoryId: 1 }, { id: 2, name: 'Bank ‚Üí Cash', categoryId: 1 }, { id: 3, name: 'bKash ‚Üí Nagad', categoryId: 1 }, { id: 4, name: 'Cash ‚Üí Bank', categoryId: 1 },
    { id: 5, name: 'Bank Savings', categoryId: 2 }, { id: 6, name: 'Cash Savings', categoryId: 2 }, { id: 7, name: 'DPS / FD', categoryId: 2 }, { id: 8, name: 'Investments', categoryId: 2 }, { id: 9, name: 'Emergency Fund', categoryId: 2 }, { id: 10, name: 'Retirement Fund', categoryId: 2 },
    { id: 11, name: 'Food & Groceries', categoryId: 3 }, { id: 12, name: 'Rent / House', categoryId: 3 }, { id: 13, name: 'Utilities', categoryId: 3 }, { id: 14, name: 'Transport', categoryId: 3 }, { id: 15, name: 'Education', categoryId: 3 }, { id: 16, name: 'Medical & Health', categoryId: 3 }, { id: 17, name: 'Shopping', categoryId: 3 }, { id: 18, name: 'Entertainment', categoryId: 3 }, { id: 19, name: 'Loan Payment', categoryId: 3 },
    { id: 20, name: 'Salary / Wages', categoryId: 4 }, { id: 21, name: 'Freelance / Projects', categoryId: 4 }, { id: 22, name: 'Gifts / Bonus', categoryId: 4 }, { id: 23, name: 'Investment Income', categoryId: 4 }, { id: 24, name: 'Other Income', categoryId: 4 },
    { id: 25, name: 'Lent Money', categoryId: 5 }, { id: 26, name: 'Borrowed Money', categoryId: 5 }, { id: 27, name: 'Loan Repaid', categoryId: 5 }, { id: 28, name: 'Loan Received Back', categoryId: 5 }
  ];

  let wallets=[], categories=[], subcategories=[], transactions=[];
  let currentCategoryIdForSubcategory = null, deleteCallback = null;
  let expensePieChart=null, incomeExpenseBarChart=null;

  /* API */
  const api = {
    async load(){
      try{
        const r = await fetch(`${GOOGLE_SCRIPT_URL}?action=getAll`);
        if(!r.ok) throw new Error('Network');
        return await r.json();
      }catch(e){
        return {
          wallets: JSON.parse(localStorage.getItem('advTrackerWallets')) || [{ id:1, name:'Cash', balance:0 }, { id:2, name:'Bank', balance:0 }, { id:3, name:'bKash', balance:0 }, { id:4, name:'Nagad', balance:0 }],
          categories: JSON.parse(localStorage.getItem('advTrackerCategories')) || defaultCategories,
          subcategories: JSON.parse(localStorage.getItem('advTrackerSubcategories')) || defaultSubcategories,
          transactions: JSON.parse(localStorage.getItem('advTrackerTransactions')) || []
        };
      }
    },
    async save(data){
      try{
        const r = await fetch(GOOGLE_SCRIPT_URL, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:'saveAll', data})});
        if(!r.ok) throw new Error('Network'); await r.json();
      }catch(e){
        localStorage.setItem('advTrackerWallets', JSON.stringify(data.wallets));
        localStorage.setItem('advTrackerCategories', JSON.stringify(data.categories));
        localStorage.setItem('advTrackerSubcategories', JSON.stringify(data.subcategories));
        localStorage.setItem('advTrackerTransactions', JSON.stringify(data.transactions));
      }
    },
    async callScript(action, params={}){
      try{
        const url = new URL(GOOGLE_SCRIPT_URL);
        Object.entries(params).forEach(([k,v])=> url.searchParams.append(k, v));
        url.searchParams.append('action', action);
        const r = await fetch(url);
        if(!r.ok) throw new Error('Network');
        return await r.json();
      }catch(e){ return {status:'error', message:e.toString()}; }
    }
  };

  /* Helpers */
  const typeSign = t => t==='transfer' ? '‚ÜîÔ∏è' : (['expense','asset','liability'].includes(t) ? '-' : '+');
  const typeClass = t => t==='transfer'?'tr' : t==='income'?'in' : t==='expense'?'ex' : t==='asset'?'as' : 'li';

  const updateWalletBalance = (walletId, amount, type, subName, isSource=true) => {
    const w = wallets.find(x=>x.id===walletId); if(!w) return;
    if (type==='transfer') return;
    if (type==='asset' && subName==='Loan Received Back'){ w.balance += amount; return; }
    if (type==='liability' && subName==='Loan Repaid'){ w.balance -= amount; return; }
    if (isSource){
      if (['expense','asset','liability'].includes(type)) w.balance -= amount;
      if (type==='income') w.balance += amount;
    }else{
      if (type==='asset') w.balance += amount;
      if (type==='liability') w.balance -= amount;
    }
  };
  const reverseWalletBalance = (t) => {
    const w = wallets.find(x=>x.id===t.walletId);
    const c = categories.find(x=>x.id===t.categoryId);
    const s = subcategories.find(x=>x.id===t.subcategoryId);
    if(!c) return;
    if (c.type==='transfer'){ const toW = wallets.find(x=>x.id===t.toWalletId); if(w) w.balance += t.amount; if(toW) toW.balance -= t.amount; return; }
    if (c.type==='asset' && s?.name==='Loan Received Back'){ if(w) w.balance -= t.amount; return; }
    if (c.type==='liability' && s?.name==='Loan Repaid'){ if(w) w.balance += t.amount; return; }
    if (['expense','asset','liability'].includes(c.type)){ if(w) w.balance += t.amount; }
    if (c.type==='income'){ if(w) w.balance -= t.amount; }
  };

  /* Render */
  const renderWallets = () => {
    walletsGrid.innerHTML = ''; walletSelect.innerHTML = ''; editWalletSelect.innerHTML=''; toWalletSelect.innerHTML=''; editToWalletSelect.innerHTML='';
    wallets.forEach(w=>{
      const card = document.createElement('div');
      card.className = 'wallet';
      card.innerHTML = `<h4>${w.name}</h4><p>‡ß≥${(w.balance||0).toFixed(2)}</p>`;
      walletsGrid.appendChild(card);
      const opt = new Option(w.name, w.id);
      walletSelect.add(opt.cloneNode(true)); editWalletSelect.add(opt.cloneNode(true));
      toWalletSelect.add(opt.cloneNode(true)); editToWalletSelect.add(opt.cloneNode(true));
    });
    const add = document.createElement('div');
    add.className = 'wallet'; add.style.borderStyle='dashed'; add.style.textAlign='center'; add.style.cursor='pointer';
    add.innerHTML = `<h4>+ Add Wallet</h4><p style="color:var(--muted)">Create a wallet</p>`;
    add.onclick = ()=>{ const name = prompt('Enter new wallet name:'); if(name) addWallet(name); };
    walletsGrid.appendChild(add);
  };

  const renderSummary = () => {
    let income=0, expense=0, lent=0, borrowed=0, savings=0, lentBack=0, borrowedPaid=0;
    transactions.forEach(t=>{
      const c = categories.find(x=>x.id===t.categoryId); if(!c) return;
      const s = subcategories.find(x=>x.id===t.subcategoryId); const a=t.amount; const sn=s?.name||'';
      if(c.type==='income') income += a;
      if(c.type==='expense'){ expense += a; if(c.name==='Savings / Investments') savings += a; }
      if(c.type==='asset'){ if(sn==='Lent Money') lent += a; if(sn==='Loan Received Back') lentBack += a; }
      if(c.type==='liability'){ if(sn==='Borrowed Money') borrowed += a; if(sn==='Loan Repaid') borrowedPaid += a; }
    });
    const walletBal = wallets.reduce((s,w)=> s + (w.balance||0), 0);
    const net = walletBal - (borrowed - borrowedPaid);
    $('#totalIncome').textContent = `‡ß≥${income.toFixed(2)}`;
    $('#totalExpense').textContent = `‡ß≥${expense.toFixed(2)}`;
    $('#totalLent').textContent = `‡ß≥${(lent - lentBack).toFixed(2)}`;
    $('#totalBorrowed').textContent = `‡ß≥${(borrowed - borrowedPaid).toFixed(2)}`;
    $('#netWorth').textContent = `‡ß≥${net.toFixed(2)}`;
    $('#totalSavings').textContent = `‡ß≥${savings.toFixed(2)}`;
  };

  const renderCharts = () => {
    const expenseData = {}; const monthly = {};
    transactions.forEach(t=>{
      const c = categories.find(x=>x.id===t.categoryId); if(!c) return;
      const s = subcategories.find(x=>x.id===t.subcategoryId);
      const label = s ? s.name : c.name;
      const m = new Date(t.date).toLocaleDateString('en-US',{year:'numeric', month:'short'});
      if(c.type==='expense') expenseData[label] = (expenseData[label]||0) + t.amount;
      if(!monthly[m]) monthly[m] = {income:0, expense:0};
      if(c.type==='income') monthly[m].income += t.amount;
      if(c.type==='expense') monthly[m].expense += t.amount;
    });

    const pieCtx = document.getElementById('expensePieChart').getContext('2d');
    if (expensePieChart) expensePieChart.destroy();
    expensePieChart = new Chart(pieCtx, {
      type:'pie',
      data:{ labels:Object.keys(expenseData),
        datasets:[{ data:Object.values(expenseData),
          backgroundColor:['#0ea5e9','#8b5cf6','#ef4444','#f59e0b','#22c55e','#e11d48'] }]},
      options:{responsive:true, plugins:{legend:{position:'top'}, title:{display:true,text:'Expense Breakdown'}}}
    });

    const barCtx = document.getElementById('incomeExpenseBarChart').getContext('2d');
    if (incomeExpenseBarChart) incomeExpenseBarChart.destroy();
    const months = Object.keys(monthly).sort((a,b)=> new Date(a) - new Date(b));
    incomeExpenseBarChart = new Chart(barCtx,{
      type:'bar',
      data:{
        labels:months,
        datasets:[
          {label:'Income', data: months.map(m=>monthly[m].income), backgroundColor:'rgba(22,163,74,.75)', borderColor:'#16a34a', borderWidth:1},
          {label:'Expense', data: months.map(m=>monthly[m].expense), backgroundColor:'rgba(239,68,68,.75)', borderColor:'#ef4444', borderWidth:1}
        ]
      },
      options:{responsive:true, scales:{y:{beginAtZero:true}}, plugins:{legend:{position:'top'}, title:{display:true, text:'Income vs Expense'}}}
    });
  };

  const renderTransactions = (arr = transactions) => {
    transactionList.innerHTML = '';
    const list = [...arr].sort((a,b)=> new Date(b.date) - new Date(a.date));
    if(!list.length){ transactionList.innerHTML = `<li class="item">No transactions found.</li>`; return; }
    list.forEach(t=>{
      const w = wallets.find(x=>x.id==t.walletId), c = categories.find(x=>x.id==t.categoryId), s = subcategories.find(x=>x.id==t.subcategoryId);
      const klass = c ? typeClass(c.type) : 'ex', sign = c ? typeSign(c.type) : '-';
      const d = new Date(t.date).toLocaleDateString(undefined,{year:'numeric', month:'short', day:'numeric'});
      const li = document.createElement('li'); li.className='item';
      li.innerHTML = `
        <div class="topline">
          <div style="font-weight:800">${t.description}</div>
          <div class="amt ${klass}">${sign}‡ß≥${t.amount.toFixed(2)}</div>
        </div>
        <div class="meta">${d} ‚Ä¢ ${(w?w.name:'N/A')} ‚Ä¢ ${(c?c.name:'N/A')} ‚Üí ${(s?s.name:'N/A')}</div>
        <div class="row" style="justify-content:flex-end; margin-top:8px">
          <button class="btn small btn-ghost" data-edit="${t.id}">‚úèÔ∏è Edit</button>
          <button class="btn small btn-danger" data-del="${t.id}">üóëÔ∏è Delete</button>
        </div>`;
      transactionList.appendChild(li);
    });
  };

  const renderCategories = () => {
    // Group by type for perfect clarity
    const types = ['income','expense','asset','liability','transfer'];
    const labels = {income:'Income', expense:'Expense', asset:'Asset (Lent)', liability:'Liability (Borrowed)', transfer:'Transfer'};
    categoryListEl.innerHTML = '';
    types.forEach(tp=>{
      const groupCats = categories.filter(c=> c.type===tp);
      const group = document.createElement('div'); group.className='group';
      group.innerHTML = `<div class="row" style="justify-content:space-between; align-items:center">
        <div style="display:flex; align-items:center; gap:10px"><h2 style="margin:0; color:var(--ink)">${labels[tp]}</h2><span class="chip-type">${groupCats.length} categories</span></div>
      </div>`;
      // each category
      groupCats.forEach(cat=>{
        const subs = subcategories.filter(s=> s.categoryId===cat.id);
        const catBlock = document.createElement('div'); catBlock.style.marginTop='8px';
        catBlock.innerHTML = `
          <div class="row" style="align-items:center; justify-content:space-between">
            <div><strong>${cat.name}</strong></div>
            <div class="row">
              <button class="btn small btn-ghost" data-editcat="${cat.id}">Edit</button>
              <button class="btn small btn-danger" data-delcat="${cat.id}">Delete</button>
            </div>
          </div>
        `;
        // subcategories
        if(subs.length){
          subs.forEach(s=>{
            const line = document.createElement('div'); line.className='subrow';
            line.innerHTML = `<div>${s.name}</div>
              <div class="row">
                <button class="btn small btn-ghost" data-editsub="${s.id}">Edit</button>
                <button class="btn small btn-danger" data-delsub="${s.id}">Delete</button>
              </div>`;
            catBlock.appendChild(line);
          });
        }else{
          const none = document.createElement('div'); none.className='subrow'; none.innerHTML = `<div style="color:var(--muted); font-style:italic">No subcategories</div>`;
          catBlock.appendChild(none);
        }
        const addBtn = document.createElement('button'); addBtn.className='btn small'; addBtn.textContent='+ Add Subcategory'; addBtn.setAttribute('data-addsub', cat.id);
        addBtn.style.marginTop='6px';
        catBlock.appendChild(addBtn);
        group.appendChild(catBlock);
      });

      categoryListEl.appendChild(group);
    });
  };

  const populateCategoryDropdowns = () => {
    categorySelect.innerHTML=''; editCategorySelect.innerHTML=''; categorySearchSelect.innerHTML='<option value="all">All Categories</option>';
    categories.forEach(c=>{
      categorySelect.add(new Option(c.name, c.id));
      editCategorySelect.add(new Option(c.name, c.id));
      categorySearchSelect.add(new Option(c.name, c.id));
    });
  };
  const updateSubcategoryDropdown = (categoryId, target) => {
    const subs = subcategories.filter(s => s.categoryId == categoryId);
    target.innerHTML = ''; subs.forEach(s=> target.add(new Option(s.name, s.id)));
  };

  const renderAll = () => { renderWallets(); renderSummary(); renderTransactions(); renderCharts(); };

  /* CRUD */
  const addWallet = async (name) => {
    if (wallets.some(w => w.name.toLowerCase()===name.toLowerCase())){ alert('A wallet with this name already exists.'); return; }
    wallets.push({id: Date.now(), name, balance:0});
    await api.save({wallets, categories, subcategories, transactions});
    renderWallets(); showToast('Wallet added');
  };
  const addCategory = async () => {
    const name = $('#newCategoryName').value.trim(); const type = $('#newCategoryType').value; if(!name) return;
    categories.push({id: Date.now(), name, type});
    await api.save({wallets, categories, subcategories, transactions});
    renderCategories(); populateCategoryDropdowns(); $('#newCategoryName').value=''; showToast('Category added');
  };
  const addSubcategory = async (categoryId, name) => {
    subcategories.push({id: Date.now(), name, categoryId});
    await api.save({wallets, categories, subcategories, transactions});
    renderCategories(); showToast('Subcategory added');
  };
  const deleteCategory = async (id) => {
    subcategories = subcategories.filter(s => s.categoryId !== id);
    categories = categories.filter(c => c.id !== id);
    await api.save({wallets, categories, subcategories, transactions});
    renderCategories(); populateCategoryDropdowns(); showToast('Category deleted');
  };
  const deleteSubcategory = async (id) => {
    subcategories = subcategories.filter(s => s.id !== id);
    await api.save({wallets, categories, subcategories, transactions});
    renderCategories(); showToast('Subcategory deleted');
  };
  const editCategoryFn = async (id, name, type) => {
    const c = categories.find(x=>x.id===id); if(!c) return; c.name=name; c.type=type;
    await api.save({wallets, categories, subcategories, transactions});
    renderCategories(); populateCategoryDropdowns(); showToast('Category updated');
  };
  const editSubcategoryFn = async (id, name) => {
    const s = subcategories.find(x=>x.id===id); if(!s) return; s.name=name;
    await api.save({wallets, categories, subcategories, transactions});
    renderCategories(); populateCategoryDropdowns(); showToast('Subcategory updated');
  };

  /* Add / Edit transactions */
  const addTransaction = async (e) => {
    e.preventDefault();
    const description = $('#description').value.trim();
    const amount = parseFloat($('#amount').value);
    const date = $('#transactionDate').value;
    const walletId = parseInt($('#wallet').value);
    const categoryId = parseInt($('#category').value);
    const subcategoryId = parseInt($('#subcategory').value);
    const c = categories.find(x=>x.id===categoryId);
    const s = subcategories.find(x=>x.id===subcategoryId);

    if(!c){ alert('Please select a category.'); return; }

    let t = {id: Date.now(), description, amount, date, walletId, categoryId, subcategoryId};

    if(c.type==='transfer'){
      const toWalletId = parseInt($('#toWallet').value);
      if(!toWalletId){ alert('Please select a destination wallet.'); return; }
      if(walletId === toWalletId){ alert('Cannot transfer to the same wallet.'); return; }
      t.toWalletId = toWalletId;
      const fromW = wallets.find(w=>w.id===walletId);
      const toW = wallets.find(w=>w.id===toWalletId);
      if(fromW) fromW.balance -= amount; if(toW) toW.balance += amount;
    }else{
      updateWalletBalance(walletId, amount, c.type, s ? s.name : '');
    }

    transactions.push(t);
    await api.save({wallets, categories, subcategories, transactions});
    renderAll(); form.reset(); $('#transactionDate').value = new Date().toISOString().split('T')[0];
    transferFields.style.display='none'; switchView('v-history'); showToast('Transaction added');
  };

  const showEditModal = (id) => {
    const t = transactions.find(x=>x.id===id); if(!t) return;
    $('#editId').value = t.id;
    $('#editDescription').value = t.description;
    $('#editAmount').value = t.amount;
    $('#editTransactionDate').value = t.date;
    $('#editWallet').value = t.walletId;
    $('#editCategory').value = t.categoryId;
    updateSubcategoryDropdown(t.categoryId, editSubcategorySelect);
    $('#editSubcategory').value = t.subcategoryId;

    const c = categories.find(x=>x.id===t.categoryId);
    if(c && c.type==='transfer'){ editTransferFields.style.display = 'block'; $('#editToWallet').value = t.toWalletId; }
    else{ editTransferFields.style.display = 'none'; }
    showModal('editModal');
  };

  const updateTransaction = async (e) => {
    e.preventDefault();
    const id = parseInt($('#editId').value);
    const t = transactions.find(x=>x.id===id); if(!t) return;

    reverseWalletBalance(t);

    t.description = $('#editDescription').value.trim();
    t.amount = parseFloat($('#editAmount').value);
    t.date = $('#editTransactionDate').value;
    t.walletId = parseInt($('#editWallet').value);
    t.categoryId = parseInt($('#editCategory').value);
    t.subcategoryId = parseInt($('#editSubcategory').value);

    const c = categories.find(x=>x.id===t.categoryId);
    const s = subcategories.find(x=>x.id===t.subcategoryId);

    if(c.type==='transfer'){
      t.toWalletId = parseInt($('#editToWallet').value);
      if(!t.toWalletId || t.toWalletId===t.walletId){ alert('Choose a different destination wallet.'); return; }
      const fromW = wallets.find(w=>w.id===t.walletId);
      const toW = wallets.find(w=>w.id===t.toWalletId);
      if(fromW) fromW.balance -= t.amount; if(toW) toW.balance += t.amount;
    }else{
      updateWalletBalance(t.walletId, t.amount, c.type, s ? s.name : '');
    }

    await api.save({wallets, categories, subcategories, transactions});
    renderAll(); hideModal('editModal'); showToast('Changes saved');
  };

  /* CSV */
  const downloadCSV = (rows) => {
    const headers = ['Date','Description','Amount','Wallet','Category','Subcategory'];
    const lines = [headers.join(',')].concat(rows.map(t=>{
      const w = wallets.find(x=>x.id==t.walletId);
      const c = categories.find(x=>x.id==t.categoryId);
      const s = subcategories.find(x=>x.id==t.subcategoryId);
      return [
        t.date,
        `"${t.description.replace(/"/g,'""')}"`,
        t.amount,
        `"${w ? w.name : 'N/A'}"`,
        `"${c ? c.name : 'N/A'}"`,
        `"${s ? s.name : 'N/A'}"`
      ].join(',');
    }));
    const blob = new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = `transactions_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove();
  };

  /* Backup / Restore */
  const handleBackup = async () => {
    backupBtn.disabled = true; backupBtn.textContent = 'Creating Backup...';
    const r = await api.callScript('backupToDrive');
    backupBtn.disabled = false; backupBtn.textContent = '‚¨ÜÔ∏è Backup to Drive';
    (r.status==='success') ? showToast(r.message||'Backup complete') : showToast('Backup failed');
  };
  const handleListBackups = async () => {
    listBackupsBtn.disabled = true; listBackupsBtn.textContent = 'Loading...';
    const r = await api.callScript('listBackupFiles');
    listBackupsBtn.disabled = false; listBackupsBtn.textContent = 'üìÑ List Backups';
    restoreFileSelect.innerHTML = '<option value="">-- Select a backup --</option>'; restoreSection.style.display='block';
    if(r.status==='success' && Array.isArray(r.files) && r.files.length) r.files.forEach(f=> restoreFileSelect.add(new Option(f.name, f.id)));
    else restoreFileSelect.innerHTML = '<option value="">No backups found</option>';
  };
  const handleRestore = async () => {
    const fid = restoreFileSelect.value; if(!fid){ alert('Please select a backup file to restore.'); return; }
    if(!confirm('WARNING: This will overwrite ALL your current data. Continue?')) return;
    restoreBtn.disabled = true; restoreBtn.textContent = 'Restoring...';
    const r = await api.callScript('restoreFromDrive', {fileId: fid});
    restoreBtn.disabled = false; restoreBtn.textContent = '‚¨áÔ∏è Restore Selected';
    if(r.status==='success'){
      showToast(r.message||'Restore complete');
      const data = await api.load();
      wallets = data.wallets; categories = data.categories; subcategories = data.subcategories; transactions = data.transactions;
      renderAll(); renderCategories(); populateCategoryDropdowns();
    }else showToast('Restore failed');
  };

  /* Modals */
  const showModal = id => document.getElementById(id).classList.add('show');
  const hideModal = id => document.getElementById(id).classList.remove('show');
  const closeBtns = $$('.close[data-target], .modal .btn[data-target]');
  closeBtns.forEach(b=> b.addEventListener('click', ()=> hideModal(b.getAttribute('data-target'))));
  window.addEventListener('click', e => { if(e.target.classList?.contains('modal')) e.target.classList.remove('show'); });

  /* Delegation */
  transactionList.addEventListener('click', (e) => {
    const idEdit = e.target.getAttribute('data-edit');
    const idDel  = e.target.getAttribute('data-del');
    if(idEdit){ showEditModal(parseInt(idEdit)); }
    else if(idDel){
      $('#deleteConfirmMessage').textContent='Delete this transaction?';
      deleteCallback = async ()=>{ const id = parseInt(idDel); const t = transactions.find(x=>x.id===id); if(t){ reverseWalletBalance(t); transactions = transactions.filter(x=>x.id!==id); await api.save({wallets, categories, subcategories, transactions}); renderAll(); showToast('Deleted'); } };
      showModal('deleteConfirmModal');
    }
  });
  $('#confirmDeleteBtn').addEventListener('click', ()=>{ if(deleteCallback) deleteCallback(); hideModal('deleteConfirmModal'); });

  categoryListEl.addEventListener('click', (e)=>{
    const editCat = e.target.getAttribute('data-editcat');
    const delCat  = e.target.getAttribute('data-delcat');
    const addSub  = e.target.getAttribute('data-addsub');
    const editSub = e.target.getAttribute('data-editsub');
    const delSub  = e.target.getAttribute('data-delsub');
    if(editCat){
      const c = categories.find(x=>x.id==editCat);
      if(c){ $('#editCategoryId').value=c.id; $('#editCategoryName').value=c.name; $('#editCategoryType').value=c.type; showModal('editCategoryModal'); }
    }else if(delCat){
      const id = parseInt(delCat);
      $('#deleteConfirmMessage').textContent='Delete this category and all its subcategories?';
      deleteCallback = ()=> deleteCategory(id); showModal('deleteConfirmModal');
    }else if(addSub){
      currentCategoryIdForSubcategory = parseInt(addSub);
      $('#newSubcategoryName').value=''; showModal('addSubcategoryModal');
    }else if(editSub){
      const s = subcategories.find(x=>x.id==editSub);
      if(s){ $('#editSubcategoryId').value=s.id; $('#editSubcategoryName').value=s.name; showModal('editSubcategoryModal'); }
    }else if(delSub){
      const id = parseInt(delSub);
      $('#deleteConfirmMessage').textContent='Delete this subcategory?';
      deleteCallback = ()=> deleteSubcategory(id); showModal('deleteConfirmModal');
    }
  });
  $('#saveSubcategoryBtn').addEventListener('click', ()=>{
    const name = $('#newSubcategoryName').value.trim(); if(!name) return;
    addSubcategory(currentCategoryIdForSubcategory, name); hideModal('addSubcategoryModal');
  });
  $('#saveCategoryChangesBtn').addEventListener('click', ()=>{
    const id = parseInt($('#editCategoryId').value);
    const name = $('#editCategoryName').value.trim();
    const type = $('#editCategoryType').value;
    if(!name) return; editCategoryFn(id,name,type); hideModal('editCategoryModal');
  });
  $('#saveSubcategoryChangesBtn').addEventListener('click', ()=>{
    const id = parseInt($('#editSubcategoryId').value);
    const name = $('#editSubcategoryName').value.trim();
    if(!name) return; editSubcategoryFn(id,name); hideModal('editSubcategoryModal');
  });

  categorySelect.addEventListener('change', ()=>{
    const c = categories.find(x=>x.id==categorySelect.value);
    transferFields.style.display = (c && c.type==='transfer') ? 'block' : 'none';
    updateSubcategoryDropdown(categorySelect.value, subcategorySelect);
  });
  editCategorySelect.addEventListener('change', ()=>{
    const c = categories.find(x=>x.id==editCategorySelect.value);
    editTransferFields.style.display = (c && c.type==='transfer') ? 'block' : 'none';
    updateSubcategoryDropdown(editCategorySelect.value, editSubcategorySelect);
  });

  categorySearchSelect.addEventListener('change', (e)=>{
    const id = e.target.value;
    if(id==='all') renderTransactions(); else renderTransactions(transactions.filter(t => t.categoryId == id));
  });
  downloadCsvBtn.addEventListener('click', ()=>{
    const id = categorySearchSelect.value;
    const rows = id==='all' ? transactions : transactions.filter(t => t.categoryId == id);
    downloadCSV(rows);
  });

  backupBtn.addEventListener('click', handleBackup);
  listBackupsBtn.addEventListener('click', handleListBackups);
  restoreFileSelect.addEventListener('change', ()=> restoreBtn.disabled = !restoreFileSelect.value);
  restoreBtn.addEventListener('click', handleRestore);

  /* INIT */
  const data = await api.load();
  wallets = data.wallets; categories = data.categories; subcategories = data.subcategories; transactions = data.transactions;
  $('#transactionDate').value = new Date().toISOString().split('T')[0];
  renderAll(); renderCategories(); populateCategoryDropdowns();
  // ensure subcategory defaults
  if(categorySelect.value) updateSubcategoryDropdown(categorySelect.value, subcategorySelect);

});
</script>
</body>
</html>
