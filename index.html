<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FinTrack Pro</title>
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts: Plus Jakarta Sans -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS Variables & Design Tokens --- */
        :root {
            /* Palette */
            --primary: #6366f1; /* Indigo 500 */
            --primary-dark: #4f46e5;
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --secondary: #64748b;
            
            /* Semantic Colors */
            --success-bg: #dcfce7;
            --success-text: #166534;
            --danger-bg: #fee2e2;
            --danger-text: #991b1b;
            --warning-bg: #fef9c3;
            --warning-text: #854d0e;
            
            /* Surfaces */
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --bg-sidebar: #ffffff;
            --border-light: rgba(148, 163, 184, 0.15);
            
            /* Typography */
            --font-main: 'Plus Jakarta Sans', sans-serif;
            --text-dark: #0f172a;
            --text-muted: #64748b;
            
            /* Effects */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-glow: 0 0 20px rgba(99, 102, 241, 0.15);
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;

            --nav-height: 70px;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: var(--font-main);
            background: var(--bg-body);
            color: var(--text-dark);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
        }

        /* --- App Container --- */
        .app-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            max-width: 1600px;
            background: var(--bg-body);
            position: relative;
        }

        /* --- Main Content Area --- */
        .main-content {
            flex-grow:1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: calc(var(--nav-height) + 40px);
            scroll-behavior: smooth;
        }
        
        .main-content::-webkit-scrollbar { width: 6px; }
        .main-content::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* --- Sections --- */
        .view-section { display: none; max-width: 1000px; margin: 0 auto; opacity: 0; transform: translateY(10px); transition: opacity 0.4s ease, transform 0.4s ease; }
        .view-section.active { display: block; opacity: 1; transform: translateY(0); }

        h1 { 
            font-size:1.5rem; 
            font-weight: 700; 
            margin-bottom:1.5rem; 
            color: var(--text-dark);
            display: flex; 
            align-items: center; 
            gap: 10px;
        }
        h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        h2::before { content: ''; display: block; width: 4px; height: 20px; background: var(--primary-gradient); border-radius: 2px; }

        /* --- Navigation --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--nav-height);
            background: rgba(255,255,255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top:1px solid var(--border-light);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.03);
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            text-decoration: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            height: 100%;
            font-size: 0.7rem;
            font-weight: 600;
            position: relative;
        }
        .nav-item span { font-size: 1.3rem; margin-bottom: 2px; transition: transform 0.3s ease; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active span { transform: translateY(-2px); }
        .nav-item.active::after {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 30%;
            height: 3px;
            background: var(--primary-gradient);
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
        }

        /* --- Desktop Layout --- */
        @media (min-width: 1024px) {
            body { background: #e2e8f0; }
            .app-container {
                flex-direction: row;
                max-width: 1400px;
                margin: 20px auto;
                height: calc(100vh - 40px);
                border-radius: var(--radius-xl);
                box-shadow: var(--shadow-lg);
                background: var(--bg-card);
                overflow: hidden;
            }
            .main-content {
                padding: 40px;
                padding-bottom: 40px;
                background: #f8fafc;
            }
            .bottom-nav {
                flex-direction: column;
                width: 260px;
                height: 100%;
                position: relative;
                background: #ffffff;
                border-top: none;
                border-right: 1px solid var(--border-light);
                justify-content: flex-start;
                padding-top: 40px;
                align-items: stretch;
            }
            .nav-item {
                flex-direction: row;
                height: 56px;
                padding: 0 32px;
                font-size: 1rem;
                justify-content: flex-start;
                gap: 16px;
            }
            .nav-item span { margin-bottom: 0; font-size: 1.25rem; }
            .nav-item.active::after {
                width: 4px;
                height: 24px;
                top: 50%;
                left: 0;
                transform: translateY(-50%);
                border-radius: 0 4px 4px 0;
            }
        }

        /* --- Wallets Grid (Optimized for Mobile) --- */
        .wallets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* Smaller boxes */
            gap: 12px;
            margin-bottom: 24px;
        }
        .wallet-card {
            background: var(--bg-card);
            padding: 16px; /* Reduced padding */
            border-radius: var(--radius-lg);
            text-align: left;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-sm);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: auto;
            min-height: 100px; /* Tighter height */
        }
        .wallet-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 4px; /* Thinner accent */
            background: var(--primary-gradient);
        }
        .wallet-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .wallet-card h4 { 
            margin: 0 0 6px 0; 
            font-size: 0.85rem; /* Smaller text */
            color: var(--text-muted); 
            font-weight: 500; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .wallet-card p { 
            margin: 0; 
            font-size: 1.1rem; /* Smaller font size */
            font-weight: 700; 
            color: var(--text-dark); 
        }
        
        .add-wallet-btn {
            background: rgba(99, 102, 241, 0.03);
            border: 2px dashed #cbd5e1;
            color: var(--primary);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            height: auto;
            min-height: 100px;
        }
        .add-wallet-btn:hover { 
            border-color: var(--primary); 
            background: rgba(99, 102, 241, 0.1);
        }
        .add-wallet-btn h4 { margin: 0; color: var(--primary); font-size: 0.85rem; }

        /* --- Summary Grid --- */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2 Columns on mobile */
            gap: 12px;
            margin-bottom: 32px;
        }
        @media(min-width: 600px) {
            .summary-grid { grid-template-columns: repeat(3, 1fr); }
        }
        .summary-card { 
            background: var(--bg-card);
            padding: 16px; 
            border-radius: var(--radius-md); 
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            transition: transform 0.3s ease;
        }
        .summary-card:hover { transform: translateY(-2px); }
        .summary-card h3 { margin: 0 0 6px 0; font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .summary-card p { margin: 0; font-size: 1.1rem; font-weight: 700; color: var(--text-dark); }
        
        .summary-card.income h3 { color: var(--success-text); }
        .summary-card.expense h3 { color: var(--danger-text); }
        .summary-card.net-worth h3 { color: var(--primary); }

        /* --- Filters --- */
        .summary-filter-container {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 16px;
        }
        .summary-filter-container select {
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-light);
            background: white;
            color: var(--text-dark);
            font-family: var(--font-main);
            font-size: 0.85rem;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
        }

        /* --- Charts --- */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }
        @media (min-width: 768px) {
            .charts-container { grid-template-columns: 1fr 1fr; }
        }
        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow-sm);
        }

        /* --- Premium Form Styles --- */
        .tracker-form, .category-form, .backup-restore-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: var(--bg-card);
            padding: 24px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-sm);
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
        }
        
        /* Premium Category Form Specialization */
        .category-form {
            border-left: 5px solid var(--primary);
        }
        .category-form h3 {
            margin: 0 0 8px 0;
            font-size: 1.1rem;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .category-form .input-group {
            display: grid;
            grid-template-columns: 1fr 140px;
            gap: 10px;
        }

        .form-group label { 
            display: block; 
            margin-bottom: 6px; 
            font-weight: 600; 
            font-size: 0.85rem; 
            color: var(--text-muted);
            margin-left: 2px;
        }
        .form-group input, .form-group select { 
            width: 100%; 
            padding: 12px 14px; 
            border: 2px solid #f1f5f9; 
            border-radius: var(--radius-sm); 
            font-size: 0.95rem; 
            font-family: var(--font-main);
            background: #f8fafc;
            color: var(--text-dark);
            transition: all 0.2s ease;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* --- Buttons --- */
        button { 
            padding: 12px 20px; 
            background: var(--primary-gradient);
            color: white; 
            border: none; 
            border-radius: var(--radius-sm); 
            font-size: 0.95rem; 
            font-weight: 600;
            cursor: pointer; 
            transition: transform 0.1s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(99, 102, 241, 0.35); }
        button:active { transform: translateY(0); }
        
        button.danger-btn { background: linear-gradient(135deg, #ef4444, #dc2626); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.25); }
        button.success-btn { background: linear-gradient(135deg, #22c55e, #16a34a); box-shadow: 0 4px 12px rgba(34, 197, 94, 0.25); }
        button.small-btn { 
            padding: 6px 10px; 
            font-size: 0.75rem; 
            border-radius: var(--radius-sm);
            background: #f1f5f9;
            color: var(--text-muted);
            box-shadow: none;
        }
        button.small-btn:hover { background: #e2e8f0; color: var(--text-dark); transform: none; box-shadow: none; }
        
        /* --- Lists --- */
        .transaction-list { list-style: none; padding: 0; margin: 0; }
        .transaction-item { 
            background: var(--bg-card);
            margin-bottom: 10px; 
            border-radius: var(--radius-md); 
            padding: 16px;
            border: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s ease;
        }
        .transaction-item:hover { transform: translateX(2px); border-color: #cbd5e1; }
        
        .transaction-info h4 { margin: 0 0 4px 0; font-size: 0.95rem; font-weight: 600; }
        .transaction-info p { margin: 0; font-size: 0.8rem; color: var(--text-muted); }
        .transaction-amount { font-size: 1rem; font-weight: 700; margin-left: 12px; }
        .transaction-actions { display: flex; gap: 6px; margin-left: 12px; opacity: 0.5; transition: opacity 0.2s; }
        .transaction-item:hover .transaction-actions { opacity: 1; }

        .category-list { list-style: none; padding: 0; }
        .category-item { 
            border: 1px solid var(--border-light); 
            border-radius: var(--radius-md); 
            margin-bottom: 12px; 
            background: var(--bg-card);
            overflow: hidden;
        }
        .category-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px 16px; 
            background: #f8fafc; 
            font-weight: 600; 
            border-bottom: 1px solid var(--border-light);
            font-size: 0.9rem;
        }
        .subcategories { padding: 8px; }
        .subcategory-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px 16px; 
            border-bottom: 1px solid #f1f5f9; 
            font-size: 0.85rem;
        }
        .subcategory-item:last-child { border-bottom: none; }

        /* --- Modals --- */
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(15, 23, 42, 0.6); 
            backdrop-filter: blur(4px);
            justify-content: center; 
            align-items: center; 
            animation: fadeIn 0.2s ease;
        }
        .modal.show { display: flex; }
        .modal-content { 
            background: white;
            margin: 20px; 
            padding: 24px; 
            width: 100%; 
            max-width: 480px; 
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; font-size: 1.1rem; }
        .close-btn { color: #94a3b8; font-size: 1.5rem; cursor: pointer; transition: color 0.2s; line-height: 1; }
        .close-btn:hover { color: var(--text-dark); }

        /* --- Toast Notification --- */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; pointer-events: none;}
        .toast {
            min-width: 200px;
            padding: 12px 16px;
            background: white;
            border-left: 4px solid var(--primary);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slideInRight 0.3s ease;
            font-size: 0.85rem;
            font-weight: 500;
            pointer-events: auto;
        }
        .toast.success { border-color: #22c55e; }
        .toast.error { border-color: #ef4444; }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .text-success { color: var(--success-text); }
        .text-danger { color: var(--danger-text); }
        .text-primary { color: var(--primary); }
        .action-btn { background: transparent; border: none; cursor: pointer; font-size: 1.1rem; padding: 4px; border-radius: 4px; transition: background 0.2s; }
        .action-btn:hover { background: #f1f5f9; }
    </style>
</head>
<body>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <div class="app-container">
        <main class="main-content">
            
            <!-- View 1: Wallets & Dashboard -->
            <section id="view-wallets" class="view-section active">
                <h1>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
                    Dashboard
                </h1>
                
                <h2>Wallets</h2>
                <div id="walletsGrid" class="wallets-grid"></div>
                
                <div class="summary-filter-container">
                    <label for="summaryMonthFilter" style="margin-right: 8px; font-weight: 600; color: var(--text-muted); font-size: 0.9rem;">Period:</label>
                    <select id="summaryMonthFilter"></select>
                </div>

                <h2>Overview</h2>
                <div class="summary-grid">
                    <div class="summary-card income"><h3>Income</h3><p id="totalIncome" class="text-success">‡ß≥0</p></div>
                    <div class="summary-card expense"><h3>Expense</h3><p id="totalExpense" class="text-danger">‡ß≥0</p></div>
                    <div class="summary-card net-worth"><h3>Net Worth</h3><p id="netWorth" class="text-primary">‡ß≥0</p></div>
                    <div class="summary-card"><h3>Savings</h3><p id="totalSavings">‡ß≥0</p></div>
                    <div class="summary-card"><h3>Lent</h3><p id="totalLent">‡ß≥0</p></div>
                    <div class="summary-card"><h3>Borrowed</h3><p id="totalBorrowed">‡ß≥0</p></div>
                </div>
                
                <h2>Analytics</h2>
                <div class="charts-container">
                    <div class="chart-card">
                        <canvas id="expensePieChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <canvas id="incomeExpenseBarChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- View 2: Add Transaction -->
            <section id="view-add-transaction" class="view-section">
                <h1>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    New Transaction
                </h1>
                <form id="trackerForm" class="tracker-form">
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="description" placeholder="e.g., Groceries" required>
                    </div>
                    <div class="form-group">
                        <label>Amount (‡ß≥)</label>
                        <input type="number" id="amount" placeholder="0.00" step="0.01" min="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="transactionDate" required>
                    </div>
                    <div class="form-group">
                        <label>Wallet</label>
                        <select id="wallet" required></select>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="category" required></select>
                    </div>
                    <div class="form-group">
                        <label>Subcategory</label>
                        <select id="subcategory" required></select>
                    </div>
                    <div id="transferFields" style="display:none;">
                        <div class="form-group">
                            <label>Transfer To</label>
                            <select id="toWallet"></select>
                        </div>
                    </div>
                    <button type="submit">Add Transaction</button>
                </form>
            </section>

            <!-- View 3: Transaction History -->
            <section id="view-history" class="view-section">
                <h1>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    History
                </h1>
                <div style="display:flex; gap:12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; background: white; padding: 12px; border-radius: var(--radius-md); border: 1px solid var(--border-light);">
                    <div style="flex-grow:1; min-width: 150px;">
                        <label style="display:block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Filter</label>
                        <select id="categorySearch" style="width:100%; padding: 8px;">
                            <option value="all">All Categories</option>
                        </select>
                    </div>
                    <button id="downloadCsvBtn" class="success-btn" style="margin-top: auto; font-size: 0.9rem; padding: 10px 16px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        CSV
                    </button>
                </div>
                <ul id="transactionList" class="transaction-list"></ul>
            </section>

            <!-- View 4: Manage Categories -->
            <section id="view-manage-categories" class="view-section">
                <h1>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    Settings
                </h1>
                
                <div class="category-form">
                    <h3>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        Create Category
                    </h3>
                    <div class="input-group">
                        <input type="text" id="newCategoryName" placeholder="Category Name" style="flex-grow: 1;">
                        <select id="newCategoryType">
                            <option value="income">Income</option>
                            <option value="expense">Expense</option>
                            <option value="asset">Lent</option>
                            <option value="liability">Borrowed</option>
                            <option value="transfer">Transfer</option>
                        </select>
                    </div>
                    <button type="button" id="addCategoryBtn" style="width: 100%;">Add Category</button>
                </div>

                <div class="backup-restore-form" style="max-width: 100%;">
                    <h3>Data Management</h3>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                        <button type="button" id="backupBtn" class="success-btn">Backup</button>
                        <button type="button" id="listBackupsBtn">List Backups</button>
                    </div>
                    <div id="restoreSection" style="display:none; margin-top:15px; background: #f8fafc; padding: 12px; border-radius: var(--radius-md);">
                        <label style="display:block; margin-bottom: 6px; font-weight: 600; font-size: 0.85rem;">Select Backup:</label>
                        <select id="restoreFileSelect" style="margin-bottom: 8px; width: 100%;">
                            <option value="">-- Select file --</option>
                        </select>
                        <button type="button" id="restoreBtn" class="danger-btn" disabled>Restore</button>
                    </div>
                    <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--border-light);">
                    <button type="button" id="resetAllDataBtn" class="danger-btn" style="background: white; color: var(--danger-text); border: 1px solid #fee2e2; box-shadow: none;">Reset All Data</button>
                </div>

                <ul id="categoryList" class="category-list"></ul>
            </section>

        </main>

        <nav class="bottom-nav">
            <a href="#" class="nav-item active" data-target="view-wallets">
                <span>üí≥</span> Wallets
            </a>
            <a href="#" class="nav-item" data-target="view-add-transaction">
                <span>‚ûï</span> Add
            </a>
            <a href="#" class="nav-item" data-target="view-history">
                <span>üìú</span> History
            </a>
            <a href="#" class="nav-item" data-target="view-manage-categories">
                <span>‚öôÔ∏è</span> Settings
            </a>
        </nav>
    </div>

    <!-- Modals -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Edit Transaction</h2><span class="close-btn" data-target="editModal">&times;</span></div>
            <form id="editForm" class="tracker-form">
                <input type="hidden" id="editId">
                <div class="form-group"><label>Description</label><input type="text" id="editDescription" required></div>
                <div class="form-group"><label>Amount (‡ß≥)</label><input type="number" id="editAmount" step="0.01" min="0.01" required></div>
                <div class="form-group"><label>Date</label><input type="date" id="editTransactionDate" required></div>
                <div class="form-group"><label>Wallet</label><select id="editWallet" required></select></div>
                <div class="form-group"><label>Category</label><select id="editCategory" required></select></div>
                <div class="form-group"><label>Subcategory</label><select id="editSubcategory" required></select></div>
                <div id="editTransferFields" style="display:none;">
                    <div class="form-group"><label>To Wallet</label><select id="editToWallet"></select></div>
                </div>
                <button type="submit">Save Changes</button>
            </form>
        </div>
    </div>

    <div id="addSubcategoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Add Subcategory</h2><span class="close-btn" data-target="addSubcategoryModal">&times;</span></div>
            <div class="form-group" style="margin-bottom: 15px;">
                <label>Name</label>
                <input type="text" id="newSubcategoryName" placeholder="e.g., Office Supplies">
            </div>
            <div style="display:flex; justify-content: flex-end; gap: 10px;">
                <button type="button" class="danger-btn" style="background: white; color: var(--text-muted); box-shadow: none;" data-target="addSubcategoryModal">Cancel</button>
                <button type="button" id="saveSubcategoryBtn">Save</button>
            </div>
        </div>
    </div>

    <div id="editCategoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Edit Category</h2><span class="close-btn" data-target="editCategoryModal">&times;</span></div>
            <input type="hidden" id="editCategoryId">
            <div class="form-group"><label>Name</label><input type="text" id="editCategoryName" required></div>
            <div class="form-group"><label>Type</label><select id="editCategoryType">
                <option value="income">Income</option>
                <option value="expense">Expense</option>
                <option value="asset">Lent Money</option>
                <option value="liability">Borrowed Money</option>
                <option value="transfer">Transfer</option>
            </select></div>
            <div style="display:flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                <button type="button" class="danger-btn" style="background: white; color: var(--text-muted); box-shadow: none;" data-target="editCategoryModal">Cancel</button>
                <button type="button" id="saveCategoryChangesBtn">Save</button>
            </div>
        </div>
    </div>
    
    <div id="editSubcategoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Edit Subcategory</h2><span class="close-btn" data-target="editSubcategoryModal">&times;</span></div>
            <input type="hidden" id="editSubcategoryId">
            <div class="form-group"><label>Name</label><input type="text" id="editSubcategoryName" required></div>
            <div style="display:flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                <button type="button" class="danger-btn" style="background: white; color: var(--text-muted); box-shadow: none;" data-target="editSubcategoryModal">Cancel</button>
                <button type="button" id="saveSubcategoryChangesBtn">Save</button>
            </div>
        </div>
    </div>

    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Confirm</h2><span class="close-btn" data-target="deleteConfirmModal">&times;</span></div>
            <p id="deleteConfirmMessage" style="font-size: 1rem; color: var(--text-muted); margin-bottom: 20px;">Are you sure?</p>
            <div style="display:flex; justify-content: flex-end; gap: 10px;">
                <button type="button" class="danger-btn" style="background: white; color: var(--text-muted); box-shadow: none;" data-target="deleteConfirmModal">Cancel</button>
                <button type="button" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyWPsjs0tYMKTp6CMZ8XhKboYRvqROTvBDLn8cTaOgqxsW-5rev-CSajbrIYpVKLJU/exec';

            const showToast = (message, type = 'success') => {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `<span>${message}</span>`;
                container.appendChild(toast);
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateY(-20px)';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            };

            const formatCurrency = (num) => '‡ß≥' + parseFloat(num).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 });

            const navItems = document.querySelectorAll('.nav-item');
            const viewSections = document.querySelectorAll('.view-section');
            const categorySearchSelect = document.getElementById('categorySearch');
            const downloadCsvBtn = document.getElementById('downloadCsvBtn');
            const summaryMonthFilter = document.getElementById('summaryMonthFilter');
            const form = document.getElementById('trackerForm');
            const editForm = document.getElementById('editForm');
            const transactionList = document.getElementById('transactionList');
            const walletsGrid = document.getElementById('walletsGrid');
            const categoryList = document.getElementById('categoryList');
            const categorySelect = document.getElementById('category');
            const subcategorySelect = document.getElementById('subcategory');
            const walletSelect = document.getElementById('wallet');
            const toWalletSelect = document.getElementById('toWallet');
            const transferFields = document.getElementById('transferFields');
            const backupBtn = document.getElementById('backupBtn');
            const listBackupsBtn = document.getElementById('listBackupsBtn');
            const restoreSection = document.getElementById('restoreSection');
            const restoreFileSelect = document.getElementById('restoreFileSelect');
            const restoreBtn = document.getElementById('restoreBtn');
            const resetAllDataBtn = document.getElementById('resetAllDataBtn');
            const modals = document.querySelectorAll('.modal');
            const closeModalBtns = document.querySelectorAll('.close-btn[data-target], button[data-target]');
            const newSubcategoryNameInput = document.getElementById('newSubcategoryName');
            const saveSubcategoryBtn = document.getElementById('saveSubcategoryBtn');
            const editCategoryIdInput = document.getElementById('editCategoryId');
            const editCategoryNameInput = document.getElementById('editCategoryName');
            const editCategoryTypeSelect = document.getElementById('editCategoryType');
            const saveCategoryChangesBtn = document.getElementById('saveCategoryChangesBtn');
            const editSubcategoryIdInput = document.getElementById('editSubcategoryId');
            const editSubcategoryNameInput = document.getElementById('editSubcategoryName');
            const saveSubcategoryChangesBtn = document.getElementById('saveSubcategoryChangesBtn');
            const deleteConfirmMessage = document.getElementById('deleteConfirmMessage');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            const editCategorySelect_inForm = document.getElementById('editCategory');
            const editSubcategorySelect_inForm = document.getElementById('editSubcategory');
            const editWalletSelect_inForm = document.getElementById('editWallet');
            const editToWalletSelect_inForm = document.getElementById('editToWallet');
            const editTransferFields_inForm = document.getElementById('editTransferFields');

            const defaultCategories = [
                { id: 1, name: 'Accounts / Wallets', type: 'transfer' },
                { id: 2, name: 'Savings / Investments', type: 'expense' },
                { id: 3, name: 'Expense', type: 'expense' },
                { id: 4, name: 'Income', type: 'income' },
                { id: 5, name: 'Lending / Borrowing', type: 'asset' }
            ];
            const defaultSubcategories = [
                { id: 1, name: 'Bank ‚Üí bKash', categoryId: 1 }, { id: 2, name: 'Bank ‚Üí Cash', categoryId: 1 }, { id: 3, name: 'bKash ‚Üí Nagad', categoryId: 1 }, { id: 4, name: 'Cash ‚Üí Bank', categoryId: 1 },
                { id: 5, name: 'Bank Savings', categoryId: 2 }, { id: 6, name: 'Cash Savings', categoryId: 2 }, { id: 7, name: 'DPS / FD', categoryId: 2 }, { id: 8, name: 'Investments', categoryId: 2 },
                { id: 11, name: 'Food & Groceries', categoryId: 3 }, { id: 12, name: 'Rent / House', categoryId: 3 }, { id: 13, name: 'Utilities', categoryId: 3 }, { id: 14, name: 'Transport', categoryId: 3 }, { id: 15, name: 'Education', categoryId: 3 }, { id: 16, name: 'Medical', categoryId: 3 }, { id: 17, name: 'Shopping', categoryId: 3 },
                { id: 20, name: 'Salary / Wages', categoryId: 4 }, { id: 21, name: 'Freelance', categoryId: 4 }, { id: 22, name: 'Gifts', categoryId: 4 }, { id: 23, name: 'Other Income', categoryId: 4 },
                { id: 25, name: 'Lent Money', categoryId: 5 }, { id: 26, name: 'Borrowed Money', categoryId: 5 }, { id: 27, name: 'Loan Repaid', categoryId: 5 }, { id: 28, name: 'Loan Received Back', categoryId: 5 }
            ];
            
            let wallets = [], categories = [], subcategories = [], transactions = [];
            let currentCategoryIdForSubcategory = null, deleteCallback = null;
            let expensePieChart = null, incomeExpenseBarChart = null;

            const api = {
                async load() {
                    if (GOOGLE_SCRIPT_URL) {
                        try {
                            const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getAll`);
                            if (!response.ok) throw new Error("Network error");
                            return await response.json();
                        } catch (error) {
                            return this.loadLocal();
                        }
                    } else {
                        return this.loadLocal();
                    }
                },
                loadLocal() {
                    return {
                        wallets: JSON.parse(localStorage.getItem('advTrackerWallets')) || [{ id: 1, name: 'Cash', balance: 0 }, { id: 2, name: 'Bank', balance: 0 }, { id: 3, name: 'bKash', balance: 0 }, { id: 4, name: 'Nagad', balance: 0 }],
                        categories: JSON.parse(localStorage.getItem('advTrackerCategories')) || defaultCategories,
                        subcategories: JSON.parse(localStorage.getItem('advTrackerSubcategories')) || defaultSubcategories,
                        transactions: JSON.parse(localStorage.getItem('advTrackerTransactions')) || []
                    };
                },
                async save(data) {
                    if (GOOGLE_SCRIPT_URL) {
                        try {
                            await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'saveAll', data }) });
                        } catch (e) { console.log(e); this.saveLocal(data); }
                    } else { this.saveLocal(data); }
                },
                saveLocal(data) {
                    localStorage.setItem('advTrackerWallets', JSON.stringify(data.wallets));
                    localStorage.setItem('advTrackerCategories', JSON.stringify(data.categories));
                    localStorage.setItem('advTrackerSubcategories', JSON.stringify(data.subcategories));
                    localStorage.setItem('advTrackerTransactions', JSON.stringify(data.transactions));
                },
                async callScript(action, params = {}) {
                    try {
                        const url = new URL(GOOGLE_SCRIPT_URL);
                        Object.keys(params).forEach(k => url.searchParams.append(k, params[k]));
                        url.searchParams.append('action', action);
                        return await (await fetch(url)).json();
                    } catch (e) { return { status: "error", message: e.toString() }; }
                }
            };

            const updateWalletBalance = (walletId, amount, categoryType, subcategoryName, isSource = true) => {
                const wallet = wallets.find(w => w.id === walletId);
                if (!wallet || categoryType === 'transfer') return;
                if (categoryType === 'asset' && subcategoryName === 'Loan Received Back') { wallet.balance += amount; return; }
                if (categoryType === 'liability' && subcategoryName === 'Loan Repaid') { wallet.balance -= amount; return; }
                if (categoryType === 'asset' && subcategoryName === 'Borrowed Money') { wallet.balance += amount; return; }
                if (isSource) {
                    if (['expense', 'asset', 'liability'].includes(categoryType)) wallet.balance -= amount;
                    if (['income'].includes(categoryType)) wallet.balance += amount;
                } else {
                    if (categoryType === 'asset') wallet.balance += amount;
                    if (categoryType === 'liability') wallet.balance -= amount;
                }
            };
            
            const reverseWalletBalance = (t) => {
                const wallet = wallets.find(w => w.id === t.walletId);
                if (!wallet) return;
                const category = categories.find(c => c.id === t.categoryId);
                const subcategory = subcategories.find(s => s.id === t.subcategoryId);
                const type = category ? category.type : 'expense';
                const subName = subcategory ? subcategory.name : '';
                if (type === 'transfer') {
                    const toWallet = wallets.find(w => w.id === t.toWalletId);
                    if (wallet) wallet.balance += t.amount;
                    if (toWallet) toWallet.balance -= t.amount;
                } else {
                    if (type === 'asset' && subName === 'Loan Received Back') { wallet.balance -= t.amount; return; }
                    if (type === 'liability' && subName === 'Loan Repaid') { wallet.balance += t.amount; return; }
                    if (type === 'asset' && subName === 'Borrowed Money') { wallet.balance -= t.amount; return; }
                    if (['expense', 'asset', 'liability'].includes(type)) wallet.balance += t.amount;
                    if (['income'].includes(type)) wallet.balance -= t.amount;
                }
            };

            const renderWallets = () => {
                walletsGrid.innerHTML = ''; 
                walletSelect.innerHTML = ''; editWalletSelect_inForm.innerHTML = ''; toWalletSelect.innerHTML = ''; editToWalletSelect_inForm.innerHTML = '';
                wallets.forEach(wallet => {
                    const card = document.createElement('div'); card.className = 'wallet-card';
                    card.innerHTML = `<div><h4>${wallet.name}</h4><p>${formatCurrency(wallet.balance)}</p></div>`; 
                    walletsGrid.appendChild(card);
                    const opt = new Option(wallet.name, wallet.id);
                    walletSelect.add(opt.cloneNode(true)); editWalletSelect_inForm.add(opt.cloneNode(true));
                    toWalletSelect.add(opt.cloneNode(true)); editToWalletSelect_inForm.add(opt.cloneNode(true));
                });
                const addBtn = document.createElement('div'); addBtn.className = 'wallet-card add-wallet-btn';
                addBtn.innerHTML = `<h4>+ Add Wallet</h4>`; addBtn.onclick = () => showAddWalletModal(); 
                walletsGrid.appendChild(addBtn);
            };

            const renderCategories = () => {
                categoryList.innerHTML = '';
                categories.forEach(cat => {
                    const li = document.createElement('li'); li.className = 'category-item';
                    const subcats = subcategories.filter(s => s.categoryId === cat.id);
                    li.innerHTML = `
                        <div class="category-header"><span>${cat.name} <small>(${cat.type})</small></span><div><button class="small-btn edit-category-btn" data-id="${cat.id}">Edit</button><button class="small-btn delete-category-btn" data-id="${cat.id}">Del</button></div></div>
                        <div class="subcategories">${subcats.map(s => `<div class="subcategory-item"><span>${s.name}</span><div><button class="small-btn edit-subcategory-btn" data-id="${s.id}">Edit</button><button class="small-btn delete-subcategory-btn" data-id="${s.id}">Del</button></div></div>`).join('') || '<div style="padding:10px 16px;color:#94a3b8;font-size:0.8rem;">No subcategories</div>'}<button class="small-btn add-subcategory-btn" data-id="${cat.id}">+ Add Sub</button></div>
                    `;
                    categoryList.appendChild(li);
                });
            };

            const populateCategoryDropdowns = () => {
                categorySelect.innerHTML = ''; editCategorySelect_inForm.innerHTML = ''; categorySearchSelect.innerHTML = '<option value="all">All Categories</option>';
                categories.forEach(c => { categorySelect.add(new Option(c.name, c.id)); editCategorySelect_inForm.add(new Option(c.name, c.id)); categorySearchSelect.add(new Option(c.name, c.id)); });
            };
            
            // --- FIXED: Added logic to handle categories with no subcategories ---
            const updateSubcategoryDropdown = (catId, target) => {
                const subs = subcategories.filter(s => s.categoryId == catId);
                target.innerHTML = '';
                if (subs.length === 0) {
                    // If no subcategories, add a "General" option so the form can be submitted
                    target.add(new Option('General (No Subcategory)', 0));
                } else {
                    subs.forEach(s => target.add(new Option(s.name, s.id)));
                }
            };

            const populateSummaryFilter = () => {
                const months = new Set();
                transactions.forEach(t => months.add(new Date(t.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short' })));
                summaryMonthFilter.innerHTML = '<option value="all">All Time</option>';
                Array.from(months).sort((a,b) => new Date(b) - new Date(a)).forEach(m => summaryMonthFilter.add(new Option(m, m)));
            };

            const renderSummary = (trs = transactions) => {
                let inc=0, exp=0, lent=0, bor=0, sav=0, lentR=0, borR=0;
                trs.forEach(t => {
                    const cat = categories.find(c => c.id === t.categoryId);
                    const sub = subcategories.find(s => s.id === t.subcategoryId);
                    if(!cat) return;
                    const type = cat.type, subName = sub ? sub.name : '';
                    switch(type){
                        case 'income': inc+=t.amount; break;
                        case 'expense': exp+=t.amount; if(cat.name==='Savings / Investments') sav+=t.amount; break;
                        case 'asset': if(subName==='Lent Money') lent+=t.amount; if(subName==='Loan Received Back') lentR+=t.amount; if(subName==='Borrowed Money') bor+=t.amount; if(subName==='Loan Repaid') borR+=t.amount; break;
                        case 'liability': if(subName==='Loan Repaid') borR+=t.amount; break;
                    }
                });
                const totalBal = wallets.reduce((a,w)=>a+w.balance,0);
                document.getElementById('totalIncome').textContent = formatCurrency(inc);
                document.getElementById('totalExpense').textContent = formatCurrency(exp);
                document.getElementById('totalLent').textContent = formatCurrency(lent-lentR);
                document.getElementById('totalBorrowed').textContent = formatCurrency(bor-borR);
                document.getElementById('netWorth').textContent = formatCurrency(totalBal - (bor-borR));
                document.getElementById('totalSavings').textContent = formatCurrency(sav);
            };

            const renderCharts = (trs = transactions) => {
                const expData={}, monData={};
                trs.forEach(t => {
                    const cat = categories.find(c => c.id === t.categoryId);
                    const sub = subcategories.find(s => s.id === t.subcategoryId);
                    if(!cat) return;
                    const name = sub ? sub.name : cat.name;
                    const m = new Date(t.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
                    if(cat.type === 'expense') expData[name] = (expData[name]||0)+t.amount;
                    monData[m] = monData[m] || {i:0, e:0};
                    if(cat.type === 'income') monData[m].i+=t.amount;
                    if(cat.type === 'expense') monData[m].e+=t.amount;
                });
                const palette = ['#6366f1','#8b5cf6','#ec4899','#f43f5e','#f97316','#eab308','#84cc16','#22c55e','#10b981','#06b6d4','#0ea5e9','#3b82f6'];
                
                const pieCtx = document.getElementById('expensePieChart').getContext('2d');
                if(expensePieChart) expensePieChart.destroy();
                expensePieChart = new Chart(pieCtx, {
                    type: 'doughnut', data: { labels: Object.keys(expData), datasets: [{ data: Object.values(expData), backgroundColor: palette, borderWidth:0 }] },
                    options: { responsive:true, cutout:'70%', plugins:{ legend:{position:'right',labels:{usePointStyle:true,font:{family:'Plus Jakarta Sans'},boxWidth:8}}, title:{display:true,text:'Expenses',font:{size:14,family:'Plus Jakarta Sans'}}} }
                });

                const barCtx = document.getElementById('incomeExpenseBarChart').getContext('2d');
                if(incomeExpenseBarChart) incomeExpenseBarChart.destroy();
                const ms = Object.keys(monData).sort((a,b)=>new Date(a)-new Date(b));
                incomeExpenseBarChart = new Chart(barCtx, {
                    type: 'bar', data: { labels: ms, datasets: [{label:'Income',data:ms.map(m=>monData[m].i),backgroundColor:'#22c55e',borderRadius:4},{label:'Expense',data:ms.map(m=>monData[m].e),backgroundColor:'#f43f5e',borderRadius:4}] },
                    options: { responsive:true, scales:{y:{beginAtZero:true,grid:{color:'#f1f5f9'},ticks:{font:{family:'Plus Jakarta Sans'}}},x:{grid:{display:false},ticks:{font:{family:'Plus Jakarta Sans'}}}}, plugins:{legend:{position:'top',labels:{usePointStyle:true,font:{family:'Plus Jakarta Sans'}}}, title:{display:true,text:'Income vs Expense',font:{size:14,family:'Plus Jakarta Sans'}}} }
                });
            };

            const renderTransactions = (trs = transactions) => {
                transactionList.innerHTML = '';
                const sorted = [...trs].sort((a,b) => new Date(b.date) - new Date(a.date));
                if(sorted.length===0) { transactionList.innerHTML = '<div style="text-align:center;padding:30px;color:#94a3b8;">No transactions found.</div>'; return; }
                sorted.forEach(t => {
                    const w = wallets.find(w=>w.id==t.walletId);
                    const c = categories.find(c=>c.id==t.categoryId);
                    const s = subcategories.find(s=>s.id==t.subcategoryId);
                    const col = getAmountClass(c?c.type:'expense');
                    const sign = getTransactionSign(c?c.type:'expense');
                    const d = new Date(t.date).toLocaleDateString('en-US', { year:'numeric', month:'short', day:'numeric' });
                    const li = document.createElement('li'); li.className = 'transaction-item';
                    li.innerHTML = `
                        <div class="transaction-info" style="flex-grow:1;">
                            <h4>${t.description}</h4>
                            <p>${d} &bull; ${w?w.name:'N/A'} &bull; ${c?c.name:'N/A'}</p>
                        </div>
                        <div style="display:flex;align-items:center;">
                            <span class="transaction-amount ${col}">${sign}${formatCurrency(t.amount)}</span>
                            <div class="transaction-actions">
                                <button class="action-btn edit-btn" data-id="${t.id}">‚úèÔ∏è</button>
                                <button class="action-btn delete-btn" data-id="${t.id}" style="color:#ef4444;">üóëÔ∏è</button>
                            </div>
                        </div>`;
                    transactionList.appendChild(li);
                });
            };
            
            const getTransactionSign = (t) => ['expense','asset','liability'].includes(t)?'':'+';
            const getAmountClass = (t) => t==='income'?'text-success':t==='expense'?'text-danger':t==='asset'?'text-primary':'';

            const addTransaction = async (e) => {
                e.preventDefault();
                const desc = document.getElementById('description').value;
                const amt = parseFloat(document.getElementById('amount').value);
                const date = document.getElementById('transactionDate').value;
                const wid = parseInt(document.getElementById('wallet').value);
                const cid = parseInt(document.getElementById('category').value);
                const sid = parseInt(document.getElementById('subcategory').value);
                const cat = categories.find(c=>c.id===cid);
                const sub = subcategories.find(s=>s.id===sid);
                
                let nt = {id:Date.now(), description:desc, amount:amt, date, walletId:wid, categoryId:cid, subcategoryId:sid};
                if(cat.type==='transfer'){
                    const twid = parseInt(document.getElementById('toWallet').value);
                    if(wid===twid) { showToast("Same wallet not allowed", "error"); return; }
                    nt.toWalletId = twid;
                    const fw = wallets.find(w=>w.id===wid);
                    const tw = wallets.find(w=>w.id===twid);
                    fw.balance-=amt; tw.balance+=amt;
                    await api.save({wallets,categories,subcategories,transactions});
                    renderWallets();
                } else { updateWalletBalance(wid, amt, cat.type, sub?sub.name:''); }

                transactions.push(nt);
                await api.save({wallets,categories,subcategories,transactions});
                renderAll();
                form.reset();
                document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
                transferFields.style.display='none';
                switchView('view-history');
                showToast("Transaction added");
            };
            
            const addWallet = async (n) => {
                if(n && !wallets.some(w=>w.name.toLowerCase()===n.toLowerCase())) {
                    wallets.push({id:Date.now(), name:n, balance:0});
                    await api.save({wallets,categories,subcategories,transactions});
                    renderWallets();
                    showToast(`Wallet "${n}" added`);
                } else if(n) { showToast("Wallet exists", "error"); }
            };
            const addCategory = async () => { 
                const n = document.getElementById('newCategoryName').value; 
                const t = document.getElementById('newCategoryType').value; 
                if(n) { 
                    categories.push({id:Date.now(), name:n, type:t}); 
                    await api.save({wallets,categories,subcategories,transactions}); 
                    renderCategories(); populateCategoryDropdowns(); 
                    document.getElementById('newCategoryName').value=''; 
                    showToast("Category added");
                } 
            };
            const addSubcategory = async (cid, n) => {
                if(n) {
                    subcategories.push({id:Date.now(), name:n, categoryId:cid});
                    await api.save({wallets,categories,subcategories,transactions});
                    renderCategories();
                    showToast("Subcategory added");
                }
            };
            const deleteCategory = async (id) => {
                subcategories = subcategories.filter(s=>s.categoryId!==id);
                categories = categories.filter(c=>c.id!==id);
                await api.save({wallets,categories,subcategories,transactions});
                renderCategories(); populateCategoryDropdowns();
                showToast("Category deleted");
            };
            const deleteSubcategory = async (id) => {
                subcategories = subcategories.filter(s=>s.id!==id);
                await api.save({wallets,categories,subcategories,transactions});
                renderCategories();
                showToast("Subcategory deleted");
            };
            const editCategory = async (id, n, t) => {
                const c = categories.find(c=>c.id===id);
                if(c) { c.name=n; c.type=t; await api.save({wallets,categories,subcategories,transactions}); renderCategories(); populateCategoryDropdowns(); showToast("Updated"); }
            };
            const editSubcategory = async (id, n) => {
                const s = subcategories.find(s=>s.id===id);
                if(s) { s.name=n; await api.save({wallets,categories,subcategories,transactions}); renderCategories(); showToast("Updated"); }
            };

            const deleteTransaction = async (id) => {
                const t = transactions.find(t=>t.id===id);
                if(t) {
                    reverseWalletBalance(t);
                    transactions = transactions.filter(t=>t.id!==id);
                    await api.save({wallets,categories,subcategories,transactions});
                    renderAll();
                    showToast("Deleted");
                }
            };
            const showEditModal = (id) => { 
                const t = transactions.find(t=>t.id===id); 
                if(t) { 
                    document.getElementById('editId').value = t.id; 
                    document.getElementById('editDescription').value = t.description; 
                    document.getElementById('editAmount').value = t.amount;
                    document.getElementById('editTransactionDate').value = t.date;
                    document.getElementById('editWallet').value = t.walletId; 
                    document.getElementById('editCategory').value = t.categoryId; 
                    updateSubcategoryDropdown(t.categoryId, editSubcategorySelect_inForm); 
                    document.getElementById('editSubcategory').value = t.subcategoryId; 
                    const c = categories.find(c=>c.id===t.categoryId); 
                    if(c.type==='transfer') { editTransferFields_inForm.style.display='block'; document.getElementById('editToWallet').value = t.toWalletId; } else { editTransferFields_inForm.style.display='none'; } 
                    showModal('editModal'); 
                } 
            };
            const updateTransaction = async (e) => { 
                e.preventDefault(); 
                const id = parseInt(document.getElementById('editId').value); 
                const t = transactions.find(t=>t.id===id); 
                if (t) { 
                    reverseWalletBalance(t); 
                    t.description = document.getElementById('editDescription').value; 
                    t.amount = parseFloat(document.getElementById('editAmount').value);
                    t.date = document.getElementById('editTransactionDate').value;
                    t.walletId = parseInt(document.getElementById('editWallet').value); 
                    t.categoryId = parseInt(document.getElementById('editCategory').value); 
                    t.subcategoryId = parseInt(document.getElementById('editSubcategory').value); 
                    const c = categories.find(c=>c.id===t.categoryId); 
                    const s = subcategories.find(s=>s.id===t.subcategoryId);
                    if(c.type==='transfer') { 
                        t.toWalletId = parseInt(document.getElementById('editToWallet').value); 
                        const fw = wallets.find(w=>w.id===t.walletId); 
                        const tw = wallets.find(w=>w.id===t.toWalletId); 
                        fw.balance -= t.amount; tw.balance += t.amount; 
                    } else { 
                        updateWalletBalance(t.walletId, t.amount, c.type, s?s.name:''); 
                    } 
                    await api.save({wallets,categories,subcategories,transactions}); 
                    renderAll(); 
                    hideModal('editModal'); 
                    showToast("Updated");
                } 
            };
            
            const renderAll = () => { renderWallets(); renderSummary(); renderTransactions(); renderCharts(); populateSummaryFilter(); };
            const switchView = (tid) => {
                viewSections.forEach(s=>s.classList.remove('active'));
                navItems.forEach(i=>i.classList.remove('active'));
                document.getElementById(tid).classList.add('active');
                document.querySelector(`[data-target="${tid}"]`).classList.add('active');
            }
            
            const showModal = (mid) => document.getElementById(mid).classList.add('show');
            const hideModal = (mid) => document.getElementById(mid).classList.remove('show');
            const showAddWalletModal = () => { const n = prompt("Wallet name:"); if(n) addWallet(n); };
            const showAddSubcategoryModal = (cid) => { currentCategoryIdForSubcategory=cid; newSubcategoryNameInput.value=''; showModal('addSubcategoryModal'); };
            const handleAddSubcategory = () => { const n = newSubcategoryNameInput.value.trim(); if(n){ addSubcategory(currentCategoryIdForSubcategory,n); hideModal('addSubcategoryModal'); }};
            const showEditCategoryModal = (id) => { const c = categories.find(c=>c.id===id); if(c){ editCategoryIdInput.value=c.id; editCategoryNameInput.value=c.name; editCategoryTypeSelect.value=c.type; showModal('editCategoryModal'); }};
            const handleEditCategory = () => { const id = parseInt(editCategoryIdInput.value); const n = editCategoryNameInput.value.trim(); const t = editCategoryTypeSelect.value; if(n){ editCategory(id,n,t); hideModal('editCategoryModal'); }};
            const showEditSubcategoryModal = (id) => { const s = subcategories.find(s=>s.id===id); if(s){ editSubcategoryIdInput.value=s.id; editSubcategoryNameInput.value=s.name; showModal('editSubcategoryModal'); }};
            const handleEditSubcategory = () => { const id = parseInt(editSubcategoryIdInput.value); const n = editSubcategoryNameInput.value.trim(); if(n){ editSubcategory(id,n); hideModal('editSubcategoryModal'); }};
            const showDeleteConfirmation = (msg, cb) => { deleteConfirmMessage.textContent=msg; deleteCallback=cb; showModal('deleteConfirmModal'); };
            const handleConfirmDelete = () => { if(deleteCallback) deleteCallback(); hideModal('deleteConfirmModal'); };

            const handleBackup = async () => {
                backupBtn.disabled=true; backupBtn.textContent='Backing up...';
                const r = await api.callScript('backupToDrive');
                if(r.status==='success') showToast(r.message); else showToast('Error: '+r.message, 'error');
                backupBtn.disabled=false; backupBtn.textContent='Backup';
            };
            const handleListBackups = async () => {
                listBackupsBtn.disabled=true; listBackupsBtn.textContent='Loading...';
                const r = await api.callScript('listBackupFiles');
                restoreFileSelect.innerHTML='<option value="">-- Select --</option>';
                if(r.status==='success' && r.files.length>0){
                    restoreSection.style.display='block';
                    r.files.forEach(f=>restoreFileSelect.add(new Option(f.name, f.id)));
                } else { restoreSection.style.display='block'; restoreFileSelect.innerHTML='<option value="">No files</option>'; }
                listBackupsBtn.disabled=false; listBackupsBtn.textContent='List Backups';
            };
            const handleRestore = async () => {
                const fid = restoreFileSelect.value;
                if(!fid) { showToast("Select a file", "error"); return; }
                if(!confirm("Overwrite ALL data?")) return;
                restoreBtn.disabled=true; restoreBtn.textContent='Restoring...';
                const r = await api.callScript('restoreFromDrive', {fileId:fid});
                if(r.status==='success'){
                    showToast(r.message);
                    const d = await api.load();
                    wallets=d.wallets; categories=d.categories; subcategories=d.subcategories; transactions=d.transactions;
                    renderAll(); renderCategories(); populateCategoryDropdowns();
                } else { showToast('Error: '+r.message, 'error'); }
                restoreBtn.disabled=false; restoreBtn.textContent='Restore';
            };
            const handleResetAllData = async () => {
                localStorage.clear();
                wallets=[{id:1,name:'Cash',balance:0},{id:2,name:'Bank',balance:0},{id:3,name:'bKash',balance:0},{id:4,name:'Nagad',balance:0}];
                categories=defaultCategories; subcategories=defaultSubcategories; transactions=[];
                await api.save({wallets,categories,subcategories,transactions});
                renderAll(); renderCategories(); populateCategoryDropdowns();
                showToast("Data reset");
            };

            const downloadCSV = (trs) => {
                const headers = ['Date','Description','Amount','Wallet','Category','Subcategory'];
                const csv = [headers.join(','), ...trs.map(t => {
                    const w = wallets.find(w=>w.id==t.walletId);
                    const c = categories.find(c=>c.id==t.categoryId);
                    const s = subcategories.find(s=>s.id==t.subcategoryId);
                    return [t.date, `"${t.description}"`, t.amount, `"${w?w.name:'N/A'}"`, `"${c?c.name:'N/A'}"`, `"${s?s.name:'N/A'}"`].join(',');
                })].join('\n');
                const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `tx_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
            };

            const data = await api.load();
            wallets = data.wallets; categories = data.categories; subcategories = data.subcategories; transactions = data.transactions;
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            renderAll(); renderCategories(); populateCategoryDropdowns(); updateSubcategoryDropdown(categorySelect.value, subcategorySelect);

            navItems.forEach(i => i.addEventListener('click', e=>{ e.preventDefault(); switchView(i.dataset.target); }));
            form.addEventListener('submit', addTransaction);
            editForm.addEventListener('submit', updateTransaction);
            document.getElementById('addCategoryBtn').addEventListener('click', addCategory);
            saveSubcategoryBtn.addEventListener('click', handleAddSubcategory);
            saveCategoryChangesBtn.addEventListener('click', handleEditCategory);
            saveSubcategoryChangesBtn.addEventListener('click', handleEditSubcategory);
            confirmDeleteBtn.addEventListener('click', handleConfirmDelete);
            backupBtn.addEventListener('click', handleBackup);
            listBackupsBtn.addEventListener('click', handleListBackups);
            restoreFileSelect.addEventListener('change', () => restoreBtn.disabled=!restoreFileSelect.value);
            restoreBtn.addEventListener('click', handleRestore);
            resetAllDataBtn.addEventListener('click', () => showDeleteConfirmation("Delete all data?", handleResetAllData));
            summaryMonthFilter.addEventListener('change', e => {
                const m = e.target.value;
                const f = m==='all'?transactions:transactions.filter(t=>new Date(t.date).toLocaleDateString('en-US',{year:'numeric',month:'short'})===m);
                renderSummary(f); renderCharts(f);
            });
            downloadCsvBtn.addEventListener('click', () => {
                const cid = categorySearchSelect.value;
                downloadCSV(cid==='all'?transactions:transactions.filter(t=>t.categoryId==cid));
            });
            closeModalBtns.forEach(b => b.addEventListener('click', () => hideModal(b.dataset.target)));
            window.onclick = e => { if(e.target.classList.contains('modal')) e.target.classList.remove('show'); };
            transactionList.addEventListener('click', e => {
                const t = e.target.closest('button');
                if(!t) return;
                if(t.classList.contains('delete-btn')) showDeleteConfirmation("Delete transaction?", () => deleteTransaction(parseInt(t.dataset.id)));
                else if(t.classList.contains('edit-btn')) showEditModal(parseInt(t.dataset.id));
            });
            categoryList.addEventListener('click', e => {
                const t = e.target.closest('button');
                if(!t) return;
                if(t.classList.contains('delete-category-btn')) showDeleteConfirmation("Delete category?", () => deleteCategory(parseInt(t.dataset.id)));
                else if(t.classList.contains('edit-category-btn')) showEditCategoryModal(parseInt(t.dataset.id));
                else if(t.classList.contains('delete-subcategory-btn')) showDeleteConfirmation("Delete subcategory?", () => deleteSubcategory(parseInt(t.dataset.id)));
                else if(t.classList.contains('edit-subcategory-btn')) showEditSubcategoryModal(parseInt(t.dataset.id));
                else if(t.classList.contains('add-subcategory-btn')) showAddSubcategoryModal(parseInt(t.dataset.id));
            });
            categorySelect.addEventListener('change', () => {
                const c = categories.find(c=>c.id==categorySelect.value);
                if(c && c.type==='transfer') transferFields.style.display='block'; else transferFields.style.display='none';
                updateSubcategoryDropdown(categorySelect.value, subcategorySelect);
            });
            editCategorySelect_inForm.addEventListener('change', () => {
                const c = categories.find(c=>c.id==editCategorySelect_inForm.value);
                if(c && c.type==='transfer') editTransferFields_inForm.style.display='block'; else editTransferFields_inForm.style.display='none';
                updateSubcategoryDropdown(editCategorySelect_inForm.value, editSubcategorySelect_inForm);
            });
            categorySearchSelect.addEventListener('change', e => {
                const cid = e.target.value;
                renderTransactions(cid==='all'?transactions:transactions.filter(t=>t.categoryId==cid));
            });
        });
    </script>
</body>
</html>
