<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Personal Finance</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  /* ============ THEME ============ */
  :root{
    --hue:185; /* accent hue (teal default) */
    --brand: hsl(var(--hue) 84% 46%);
    --brand-2: hsl(calc(var(--hue)+25) 84% 56%);
    --success:#22c55e; --danger:#ef4444; --warning:#f59e0b; --info:#06b6d4;
    --text:#0b1320; --muted:#627089;
    --card: rgba(255,255,255,.78);
    --border: rgba(0,0,0,.08);
    --nav-h:68px; --r:16px; --blur:14px;
    --shadow-sm:0 4px 14px rgba(0,0,0,.08);
    --shadow-md:0 18px 50px rgba(0,0,0,.16);
  }
  @media (prefers-color-scheme: dark){
    :root{
      --text:#eaf1ff; --muted:#9ab0cb;
      --card: rgba(10,14,24,.66);
      --border: rgba(255,255,255,.08);
      --shadow-sm:0 8px 24px rgba(0,0,0,.45);
      --shadow-md:0 28px 70px rgba(0,0,0,.5);
    }
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: ui-sans-serif, system-ui, -apple-system,"Segoe UI",Roboto,Helvetica,Arial;
    color:var(--text); background:#0b1220; overflow-x:hidden;
  }

  /* Animated Aurora Background */
  .bg{
    position:fixed; inset:-10% -10% -10% -10%; z-index:-1; filter: blur(80px);
    background:
      radial-gradient(45% 40% at 15% 10%, hsl(var(--hue) 90% 60% / .45), transparent 60%),
      radial-gradient(35% 35% at 85% 15%, hsl(calc(var(--hue)+60) 90% 60% / .38), transparent 60%),
      radial-gradient(50% 40% at 80% 80%, hsl(calc(var(--hue)+120) 90% 55% / .25), transparent 60%),
      linear-gradient(180deg, #0b1220 10%, #0f1830 100%);
    animation: drift 18s ease-in-out infinite alternate;
    opacity:.9;
  }
  @keyframes drift{
    0%{transform: translate3d(0,0,0) scale(1)}
    100%{transform: translate3d(2%, -1%, 0) scale(1.03)}
  }

  /* Glass + Neon Border */
  .glass{
    position:relative; border-radius:var(--r); background:var(--card); backdrop-filter: blur(var(--blur));
    border:1px solid var(--border); box-shadow:var(--shadow-sm);
  }
  .neon{
    background:
      linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03)) padding-box,
      conic-gradient(from 180deg, var(--brand), var(--brand-2), var(--brand)) border-box;
    border:1.5px solid transparent;
  }

  .app{min-height:100%; display:flex; flex-direction:column}
  .wrap{display:grid; grid-template-columns:1fr; gap:18px; padding:18px; padding-bottom:calc(var(--nav-h) + 22px); max-width:1200px; margin:0 auto}
  @media (min-width: 980px){ .wrap{grid-template-columns:200px 1fr; gap:20px} }

  /* Topbar */
  .top{
    position:sticky; top:0; z-index:30; height:70px; display:flex; align-items:center; justify-content:space-between;
    padding:0 14px 0 18px; margin:10px 10px 0; border-radius:18px;
  }
  .brand{
    display:flex; align-items:center; gap:12px; font-weight:900; letter-spacing:.3px;
  }
  .badge{
    width:38px; height:38px; border-radius:12px; display:grid; place-items:center; color:white; font-weight:1000;
    background:linear-gradient(135deg, var(--brand), var(--brand-2));
    box-shadow:0 10px 30px hsl(var(--hue) 90% 55% / .35);
  }
  .tools{display:flex; gap:10px; align-items:center}
  .chip{
    width:26px; height:26px; border-radius:999px; border:1px solid var(--border); cursor:pointer; box-shadow:var(--shadow-sm);
  }
  .chip[data-hue="185"]{background:hsl(185 84% 46%)}
  .chip[data-hue="265"]{background:hsl(265 84% 56%)}
  .chip[data-hue="325"]{background:hsl(325 84% 56%)}
  .chip[data-hue="95"] {background:hsl(95 84% 46%)}

  /* Side / Bottom nav */
  .nav{
    position:fixed; bottom:10px; left:50%; transform:translateX(-50%);
    width:min(92%, 680px); height:var(--nav-h); display:flex; gap:10px; align-items:center; padding:8px; border-radius:18px;
  }
  @media (min-width:980px){
    .nav{position:sticky; inset:auto; height:auto; width:auto; transform:none; top:88px; bottom:auto; flex-direction:column; padding:10px}
  }
  .tab{
    flex:1; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;
    color:var(--muted); text-decoration:none; font-weight:700; border-radius:14px; position:relative; overflow:hidden;
  }
  .tab span{font-size:1.2rem}
  .tab.active{color:var(--text)}
  .tab.active::after{
    content:""; position:absolute; inset:auto 10px 8px 10px; height:6px; border-radius:999px;
    background:linear-gradient(90deg, var(--brand), var(--brand-2));
    box-shadow:0 8px 24px hsl(var(--hue) 90% 55% / .45);
  }
  @media (min-width:980px){
    .tab{height:52px; width:100%; flex-direction:row; justify-content:flex-start; padding:0 12px}
    .tab.active::after{inset:8px auto 8px 4px; width:6px; height:auto}
  }

  /* Views */
  .content{display:flex; flex-direction:column; gap:20px}
  .view{display:none}
  .view.active{display:block}
  h1{margin:6px 0 10px; font-size:1.6rem}
  h2{margin:12px 0 10px; font-size:.98rem; text-transform:uppercase; letter-spacing:.35px; color:var(--muted)}

  /* Grids & Cards */
  .wallets{display:grid; gap:14px; grid-template-columns:repeat(auto-fit, minmax(170px,1fr))}
  .wallet{padding:18px; transition:transform .2s, box-shadow .2s}
  .wallet h4{margin:0 0 6px; font-weight:800}
  .wallet p{margin:0; font-size:1.26rem; font-weight:900; color:var(--brand)}
  .wallet:hover{transform:translateY(-4px); box-shadow:var(--shadow-md)}
  .wallet.add{border:1.5px dashed var(--border); text-align:center; cursor:pointer}
  .wallet.add p{color:var(--muted)}

  .summary{display:grid; gap:14px; grid-template-columns:repeat(auto-fit, minmax(200px,1fr))}
  .sum{padding:16px; border-radius:var(--r); position:relative; overflow:hidden}
  .sum h3{margin:0 0 6px; color:var(--muted); font-size:.9rem}
  .sum p{margin:0; font-size:1.22rem; font-weight:900}
  .sum.i{--col:var(--success)} .sum.e{--col:var(--danger)} .sum.l{--col:var(--warning)}
  .sum.b{--col:var(--info)} .sum.n{--col:hsl(265 88% 60%)} .sum.sv{--col:hsl(170 80% 46%)}
  .sum::before{
    content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
    background: radial-gradient(120px 120px at 10% 0%, var(--col,.transparent), transparent 60%);
    opacity:.25;
  }
  .sum{border:1.5px solid transparent;
       background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.02)) padding-box,
                  linear-gradient(145deg, var(--col,.transparent), transparent 70%) border-box;}

  .charts{display:grid; gap:16px; grid-template-columns:1fr 1fr}
  .chart-card{padding:16px}
  @media (max-width:820px){ .charts{grid-template-columns:1fr} }

  /* Forms */
  .form{display:flex; flex-direction:column; gap:14px; padding:18px}
  .fg{display:flex; flex-direction:column; gap:6px}
  .fg label{font-weight:800; font-size:.92rem}
  .fg input,.fg select{
    padding:12px; border-radius:12px; border:1px solid var(--border);
    background:linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.7));
    color:inherit; outline:none; transition:border-color .2s, box-shadow .2s;
  }
  @media (prefers-color-scheme: dark){
    .fg input,.fg select{background:linear-gradient(180deg, rgba(20,26,40,.9), rgba(20,26,40,.75))}
  }
  .fg input:focus,.fg select:focus{border-color:var(--brand); box-shadow:0 0 0 4px hsl(var(--hue) 90% 55% / .22)}

  /* Buttons + Ripple */
  .btn{
    position:relative; overflow:hidden; padding:12px 14px; border:none; border-radius:14px;
    color:white; font-weight:900; letter-spacing:.3px; cursor:pointer;
    background:linear-gradient(135deg, var(--brand), var(--brand-2)); box-shadow:var(--shadow-sm);
    transition:transform .12s, box-shadow .12s, filter .12s;
  }
  .btn:hover{transform:translateY(-1px); box-shadow:var(--shadow-md)}
  .btn:active{transform:translateY(0)}
  .btn.s{background:linear-gradient(135deg, var(--success), #128a3d)}
  .btn.d{background:linear-gradient(135deg, var(--danger), #b42433)}
  .btn.small{padding:7px 10px; font-size:.86rem}
  .ripple{
    position:absolute; transform:translate(-50%,-50%); border-radius:50%; pointer-events:none;
    width:8px; height:8px; background:rgba(255,255,255,.65); animation: ripple .6s ease-out forwards;
  }
  @keyframes ripple{ to{opacity:0; transform:translate(-50%,-50%) scale(20)} }

  /* History */
  .list{list-style:none; padding:0; margin:0}
  .txn{padding:14px; transition:transform .15s, box-shadow .15s}
  .txn:hover{transform:translateY(-3px); box-shadow:var(--shadow-md)}
  .row{display:flex; align-items:center; justify-content:space-between; gap:10px}
  .meta{color:var(--muted); font-size:.9rem; margin-top:4px}
  .amt{font-weight:1000; letter-spacing:.2px}
  .amt.in{color:var(--success)} .amt.ex{color:var(--danger)}
  .amt.tr{color:var(--info)} .amt.as{color:var(--warning)} .amt.li{color:var(--brand)}
  .icon-btn{border:none; background:transparent; font-size:1.2rem; cursor:pointer; padding:6px 8px; border-radius:12px; color:var(--muted)}
  .icon-btn:hover{background:rgba(255,255,255,.12); color:var(--text)}

  /* Modals */
  .modal{display:none; position:fixed; inset:0; z-index:60; background:rgba(4,7,14,.55); backdrop-filter: blur(2px); align-items:center; justify-content:center}
  .modal.show{display:flex}
  .modal-card{width:92%; max-width:560px}
  .modal-head{display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid var(--border)}
  .modal-body{padding:16px}
  .modal-foot{display:flex; justify-content:flex-end; gap:10px; padding:0 16px 16px}
  .close{font-size:26px; color:var(--muted); cursor:pointer}
  .close:hover{color:var(--text)}

  /* Toast */
  .toast{
    position:fixed; right:16px; bottom:calc(var(--nav-h) + 16px); z-index:80;
    padding:12px 14px; border-radius:14px; color:#fff; background:rgba(2,6,12,.9);
    font-weight:800; letter-spacing:.3px; opacity:0; transform:translateY(8px);
    transition:opacity .25s, transform .25s; pointer-events:none;
  }
  .toast.show{opacity:1; transform:translateY(0)}
  .toast.ok{background:linear-gradient(135deg, #16a34a, #22c55e)}
  .toast.err{background:linear-gradient(135deg, #b91c1c, #ef4444)}

  /* Floating Action Button */
  .fab{
    position:fixed; right:16px; bottom:calc(var(--nav-h) + 18px); z-index:50;
    width:60px; height:60px; border-radius:999px; display:grid; place-items:center; color:#fff;
    background:linear-gradient(135deg, var(--brand), var(--brand-2));
    box-shadow:0 18px 40px hsl(var(--hue) 90% 55% / .45);
    border:none; cursor:pointer; font-size:1.5rem;
  }

  /* Tilt (desktop only) */
  @media (pointer:fine){
    .tilt{transform-style:preserve-3d; will-change:transform}
  }
</style>
</head>
<body>
<div class="bg"></div>

<div class="app">
  <!-- Top -->
  <header class="glass neon top">
    <div class="brand">
      <div class="badge">BK</div>
      <div style="font-size:1.02rem; letter-spacing:.2px">Personal Finance</div>
    </div>
    <div class="tools">
      <div title="Teal"  class="chip" data-hue="185"></div>
      <div title="Purple" class="chip" data-hue="265"></div>
      <div title="Pink"   class="chip" data-hue="325"></div>
      <div title="Lime"   class="chip" data-hue="95"></div>
    </div>
  </header>

  <div class="wrap">
    <!-- Nav -->
    <nav class="glass neon nav">
      <a href="#" class="tab active" data-target="v-wallets"><span>üí≥</span>Wallets</a>
      <a href="#" class="tab" data-target="v-add"><span>‚ûï</span>Add</a>
      <a href="#" class="tab" data-target="v-history"><span>üìú</span>History</a>
      <a href="#" class="tab" data-target="v-cats"><span>‚öôÔ∏è</span>Categories</a>
    </nav>

    <!-- Content -->
    <main class="content">
      <!-- Wallets -->
      <section id="v-wallets" class="view active">
        <h1>Overview</h1>

        <h2>Wallets</h2>
        <div id="walletsGrid" class="wallets"></div>

        <h2>Summary</h2>
        <div class="summary">
          <div class="glass sum i tilt"><h3>Total Income</h3><p id="totalIncome">‡ß≥0.00</p></div>
          <div class="glass sum e tilt"><h3>Total Expense</h3><p id="totalExpense">‡ß≥0.00</p></div>
          <div class="glass sum l tilt"><h3>Total Lent</h3><p id="totalLent">‡ß≥0.00</p></div>
          <div class="glass sum b tilt"><h3>Total Borrowed</h3><p id="totalBorrowed">‡ß≥0.00</p></div>
          <div class="glass sum n tilt"><h3>Net Worth</h3><p id="netWorth">‡ß≥0.00</p></div>
          <div class="glass sum sv tilt"><h3>Total Savings</h3><p id="totalSavings">‡ß≥0.00</p></div>
        </div>

        <h2>Analytics</h2>
        <div class="charts">
          <div class="glass neon chart-card tilt"><canvas id="expensePieChart"></canvas></div>
          <div class="glass neon chart-card tilt"><canvas id="incomeExpenseBarChart"></canvas></div>
        </div>
      </section>

      <!-- Add -->
      <section id="v-add" class="view">
        <h1>Add Transaction</h1>
        <form id="trackerForm" class="glass neon form">
          <div class="fg"><label for="description">Description</label><input id="description" type="text" placeholder="e.g., Weekly Groceries" required/></div>
          <div class="fg"><label for="amount">Amount (‡ß≥)</label><input id="amount" type="number" step="0.01" min="0.01" placeholder="0.00" required/></div>
          <div class="fg"><label for="transactionDate">Date</label><input id="transactionDate" type="date" required/></div>
          <div class="fg"><label for="wallet">Wallet</label><select id="wallet" required></select></div>
          <div class="fg"><label for="category">Category</label><select id="category" required></select></div>
          <div class="fg"><label for="subcategory">Subcategory</label><select id="subcategory" required></select></div>
          <div id="transferFields" style="display:none">
            <div class="fg"><label for="toWallet">To Wallet</label><select id="toWallet"></select></div>
          </div>
          <button class="btn" type="submit">Add Transaction</button>
        </form>
      </section>

      <!-- History -->
      <section id="v-history" class="view">
        <h1>Transaction History</h1>
        <div class="glass neon" style="display:flex; gap:10px; padding:12px; align-items:flex-end; flex-wrap:wrap; margin-bottom:12px">
          <div class="fg" style="flex:1; margin:0">
            <label for="categorySearch">Filter by Category</label>
            <select id="categorySearch"><option value="all">All Categories</option></select>
          </div>
          <button id="downloadCsvBtn" class="btn s">üì• Download CSV</button>
        </div>
        <ul id="transactionList" class="list"></ul>
      </section>

      <!-- Categories -->
      <section id="v-cats" class="view">
        <h1>Manage Categories</h1>

        <div class="glass neon form" style="margin-bottom:12px">
          <h3 style="margin:0 0 6px 0">Add New Category</h3>
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <input id="newCategoryName" type="text" placeholder="e.g., Business" style="flex:1"/>
            <select id="newCategoryType">
              <option value="income">Income</option>
              <option value="expense">Expense</option>
              <option value="asset">Lent Money (Asset)</option>
              <option value="liability">Borrowed Money (Liability)</option>
              <option value="transfer">Transfer</option>
            </select>
          </div>
          <button id="addCategoryBtn" type="button" class="btn small">‚ûï Add Category</button>
        </div>

        <div class="glass neon form" style="margin-bottom:12px">
          <h3 style="margin:0 0 6px 0">Backup & Restore</h3>
          <p style="margin:0; color:var(--muted); font-size:.92rem">Create a backup to Google Drive or restore a previous backup.</p>
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button id="backupBtn" type="button" class="btn s">‚¨ÜÔ∏è Backup to Drive</button>
            <button id="listBackupsBtn" type="button" class="btn">üìÑ List Backups</button>
          </div>
          <div id="restoreSection" style="display:none; margin-top:8px">
            <label for="restoreFileSelect" style="font-weight:800">Select a backup:</label>
            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <select id="restoreFileSelect" style="flex:1">
                <option value="">-- Select a file --</option>
              </select>
              <button id="restoreBtn" type="button" class="btn d" disabled>‚¨áÔ∏è Restore Selected</button>
            </div>
          </div>
        </div>

        <ul id="categoryList" class="list"></ul>
      </section>
    </main>
  </div>
</div>

<!-- FAB -->
<button class="fab" id="fabAdd" title="Add transaction">Ôºã</button>

<!-- Modals -->
<div id="editModal" class="modal">
  <div class="modal-card glass neon">
    <div class="modal-head"><h2 style="margin:0">Edit Transaction</h2><span class="close" data-target="editModal">&times;</span></div>
    <form id="editForm" class="modal-body form">
      <input type="hidden" id="editId"/>
      <div class="fg"><label for="editDescription">Description</label><input id="editDescription" required/></div>
      <div class="fg"><label for="editAmount">Amount (‡ß≥)</label><input id="editAmount" type="number" step="0.01" min="0.01" required/></div>
      <div class="fg"><label for="editTransactionDate">Date</label><input id="editTransactionDate" type="date" required/></div>
      <div class="fg"><label for="editWallet">Wallet</label><select id="editWallet" required></select></div>
      <div class="fg"><label for="editCategory">Category</label><select id="editCategory" required></select></div>
      <div class="fg"><label for="editSubcategory">Subcategory</label><select id="editSubcategory" required></select></div>
      <div id="editTransferFields" style="display:none">
        <div class="fg"><label for="editToWallet">To Wallet</label><select id="editToWallet"></select></div>
      </div>
      <div class="modal-foot">
        <button type="button" class="btn d" data-target="editModal">Close</button>
        <button class="btn" type="submit">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<div id="addSubcategoryModal" class="modal">
  <div class="modal-card glass neon">
    <div class="modal-head"><h2 style="margin:0">Add New Subcategory</h2><span class="close" data-target="addSubcategoryModal">&times;</span></div>
    <div class="modal-body">
      <div class="fg"><label for="newSubcategoryName">Subcategory Name</label><input id="newSubcategoryName" placeholder="e.g., Office Supplies"/></div>
    </div>
    <div class="modal-foot">
      <button type="button" class="btn d" data-target="addSubcategoryModal">Close</button>
      <button type="button" id="saveSubcategoryBtn" class="btn">Save</button>
    </div>
  </div>
</div>

<div id="editCategoryModal" class="modal">
  <div class="modal-card glass neon">
    <div class="modal-head"><h2 style="margin:0">Edit Category</h2><span class="close" data-target="editCategoryModal">&times;</span></div>
    <div class="modal-body form">
      <input type="hidden" id="editCategoryId"/>
      <div class="fg"><label for="editCategoryName">Category Name</label><input id="editCategoryName" required/></div>
      <div class="fg"><label for="editCategoryType">Type</label>
        <select id="editCategoryType">
          <option value="income">Income</option>
          <option value="expense">Expense</option>
          <option value="asset">Lent Money (Asset)</option>
          <option value="liability">Borrowed Money (Liability)</option>
          <option value="transfer">Transfer</option>
        </select>
      </div>
    </div>
    <div class="modal-foot">
      <button type="button" class="btn d" data-target="editCategoryModal">Close</button>
      <button type="button" id="saveCategoryChangesBtn" class="btn">Save Changes</button>
    </div>
  </div>
</div>

<div id="editSubcategoryModal" class="modal">
  <div class="modal-card glass neon">
    <div class="modal-head"><h2 style="margin:0">Edit Subcategory</h2><span class="close" data-target="editSubcategoryModal">&times;</span></div>
    <div class="modal-body form">
      <input type="hidden" id="editSubcategoryId"/>
      <div class="fg"><label for="editSubcategoryName">Subcategory Name</label><input id="editSubcategoryName" required/></div>
    </div>
    <div class="modal-foot">
      <button type="button" class="btn d" data-target="editSubcategoryModal">Close</button>
      <button type="button" id="saveSubcategoryChangesBtn" class="btn">Save Changes</button>
    </div>
  </div>
</div>

<div id="deleteConfirmModal" class="modal">
  <div class="modal-card glass neon">
    <div class="modal-head"><h2 style="margin:0">Confirm Deletion</h2><span class="close" data-target="deleteConfirmModal">&times;</span></div>
    <div class="modal-body"><p id="deleteConfirmMessage" style="margin:0">Are you sure you want to delete this?</p></div>
    <div class="modal-foot">
      <button type="button" class="btn d" data-target="deleteConfirmModal">Cancel</button>
      <button type="button" id="confirmDeleteBtn" class="btn">Delete</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  /* ===== CONFIG ===== */
  const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyWPsjs0tYMKTp6CMZ8XhKboYRvqROTvBDLn8cTaOgqxsW-5rev-CSajbrIYpVKLJU/exec';

  /* ===== SHORTCUTS ===== */
  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);

  /* ===== ACCENT PICKER ===== */
  $$('.chip').forEach(c=>{
    c.addEventListener('click', ()=>{
      const hue = c.getAttribute('data-hue');
      document.documentElement.style.setProperty('--hue', hue);
    });
  });

  /* ===== RIPPLE EFFECT ===== */
  const addRipple = (e) => {
    const btn = e.currentTarget;
    const r = document.createElement('span');
    r.className = 'ripple';
    const rect = btn.getBoundingClientRect();
    r.style.left = (e.clientX - rect.left) + 'px';
    r.style.top  = (e.clientY - rect.top) + 'px';
    btn.appendChild(r);
    setTimeout(()=>r.remove(), 650);
  };
  document.addEventListener('click', (e)=>{
    if(e.target.classList.contains('btn')) addRipple(e);
  });

  /* ===== TILT (desktop only) ===== */
  const canTilt = matchMedia('(pointer:fine)').matches;
  if (canTilt){
    const tiltEls = $$('.tilt, .wallet, .txn');
    tiltEls.forEach(el=>{
      el.addEventListener('mousemove', (ev)=>{
        const r = el.getBoundingClientRect();
        const cx = ev.clientX - r.left, cy = ev.clientY - r.top;
        const rx = ((cy / r.height) - .5) * -8;
        const ry = ((cx / r.width)  - .5) * 8;
        el.style.transform = `perspective(700px) rotateX(${rx}deg) rotateY(${ry}deg) translateY(-2px)`;
      });
      el.addEventListener('mouseleave', ()=>{ el.style.transform=''; });
    });
  }

  /* ===== TOAST ===== */
  const toast = $('#toast');
  const showToast = (msg, type) => {
    toast.textContent = msg;
    toast.className = 'toast show' + (type==='ok' ? ' ok' : type==='err' ? ' err':'');
    setTimeout(() => toast.classList.remove('show'), 2200);
  };

  /* ===== NAV & VIEWS ===== */
  const tabs = $$('.tab');
  const views = $$('.view');
  const switchView = (id) => {
    views.forEach(v=>v.classList.remove('active'));
    tabs.forEach(t=>t.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelector(`.tab[data-target="${id}"]`).classList.add('active');
  };
  tabs.forEach(t=>t.addEventListener('click', e => { e.preventDefault(); switchView(t.getAttribute('data-target')); }));
  $('#fabAdd').addEventListener('click', ()=> switchView('v-add'));

  /* ===== DOM REFS ===== */
  const walletsGrid = $('#walletsGrid');
  const transactionList = $('#transactionList');
  const form = $('#trackerForm');
  const editForm = $('#editForm');

  const categoryList = $('#categoryList');
  const categorySelect = $('#category');
  const subcategorySelect = $('#subcategory');
  const walletSelect = $('#wallet');
  const toWalletSelect = $('#toWallet');
  const transferFields = $('#transferFields');

  const editCategorySelect = $('#editCategory');
  const editSubcategorySelect = $('#editSubcategory');
  const editWalletSelect = $('#editWallet');
  const editToWalletSelect = $('#editToWallet');
  const editTransferFields = $('#editTransferFields');

  const categorySearchSelect = $('#categorySearch');
  const downloadCsvBtn = $('#downloadCsvBtn');
  const backupBtn = $('#backupBtn');
  const listBackupsBtn = $('#listBackupsBtn');
  const restoreSection = $('#restoreSection');
  const restoreFileSelect = $('#restoreFileSelect');
  const restoreBtn = $('#restoreBtn');

  /* ===== DATA ===== */
  const defaultCategories = [
    { id: 1, name: 'Accounts / Wallets', type: 'transfer' },
    { id: 2, name: 'Savings / Investments', type: 'expense' },
    { id: 3, name: 'Expense', type: 'expense' },
    { id: 4, name: 'Income', type: 'income' },
    { id: 5, name: 'Lending / Borrowing', type: 'asset' }
  ];
  const defaultSubcategories = [
    { id: 1, name: 'Bank ‚Üí bKash', categoryId: 1 }, { id: 2, name: 'Bank ‚Üí Cash', categoryId: 1 }, { id: 3, name: 'bKash ‚Üí Nagad', categoryId: 1 }, { id: 4, name: 'Cash ‚Üí Bank', categoryId: 1 },
    { id: 5, name: 'Bank Savings', categoryId: 2 }, { id: 6, name: 'Cash Savings', categoryId: 2 }, { id: 7, name: 'DPS / FD', categoryId: 2 }, { id: 8, name: 'Investments', categoryId: 2 }, { id: 9, name: 'Emergency Fund', categoryId: 2 }, { id: 10, name: 'Retirement Fund', categoryId: 2 },
    { id: 11, name: 'Food & Groceries', categoryId: 3 }, { id: 12, name: 'Rent / House', categoryId: 3 }, { id: 13, name: 'Utilities', categoryId: 3 }, { id: 14, name: 'Transport', categoryId: 3 }, { id: 15, name: 'Education', categoryId: 3 }, { id: 16, name: 'Medical & Health', categoryId: 3 }, { id: 17, name: 'Shopping', categoryId: 3 }, { id: 18, name: 'Entertainment', categoryId: 3 }, { id: 19, name: 'Loan Payment', categoryId: 3 },
    { id: 20, name: 'Salary / Wages', categoryId: 4 }, { id: 21, name: 'Freelance / Projects', categoryId: 4 }, { id: 22, name: 'Gifts / Bonus', categoryId: 4 }, { id: 23, name: 'Investment Income', categoryId: 4 }, { id: 24, name: 'Other Income', categoryId: 4 },
    { id: 25, name: 'Lent Money', categoryId: 5 }, { id: 26, name: 'Borrowed Money', categoryId: 5 }, { id: 27, name: 'Loan Repaid', categoryId: 5 }, { id: 28, name: 'Loan Received Back', categoryId: 5 }
  ];

  let wallets = [], categories = [], subcategories = [], transactions = [];
  let currentCategoryIdForSubcategory = null, deleteCallback = null;
  let expensePieChart = null, incomeExpenseBarChart = null;

  /* ===== API / STORAGE ===== */
  const api = {
    async load(){
      if (!GOOGLE_SCRIPT_URL) return this.loadLocal();
      try{ const r = await fetch(`${GOOGLE_SCRIPT_URL}?action=getAll`);
        if(!r.ok) throw new Error('net'); return await r.json();
      }catch(e){ console.warn('Local fallback', e); return this.loadLocal(); }
    },
    loadLocal(){
      return {
        wallets: JSON.parse(localStorage.getItem('advTrackerWallets')) || [{ id:1, name:'Cash', balance:0 }, { id:2, name:'Bank', balance:0 }, { id:3, name:'bKash', balance:0 }, { id:4, name:'Nagad', balance:0 }],
        categories: JSON.parse(localStorage.getItem('advTrackerCategories')) || defaultCategories,
        subcategories: JSON.parse(localStorage.getItem('advTrackerSubcategories')) || defaultSubcategories,
        transactions: JSON.parse(localStorage.getItem('advTrackerTransactions')) || []
      };
    },
    async save(data){
      if (!GOOGLE_SCRIPT_URL) return this.saveLocal(data);
      try{
        const r = await fetch(GOOGLE_SCRIPT_URL, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:'saveAll', data})});
        if(!r.ok) throw new Error('net'); await r.json();
      }catch(e){ console.warn('Save local due to error', e); this.saveLocal(data); }
    },
    saveLocal(data){
      localStorage.setItem('advTrackerWallets', JSON.stringify(data.wallets));
      localStorage.setItem('advTrackerCategories', JSON.stringify(data.categories));
      localStorage.setItem('advTrackerSubcategories', JSON.stringify(data.subcategories));
      localStorage.setItem('advTrackerTransactions', JSON.stringify(data.transactions));
    },
    async callScript(action, params = {}){
      if (!GOOGLE_SCRIPT_URL) return {status:'error', message:'Script URL not configured.'};
      try{
        const url = new URL(GOOGLE_SCRIPT_URL);
        Object.entries(params).forEach(([k,v])=> url.searchParams.append(k, v));
        url.searchParams.append('action', action);
        const r = await fetch(url); if(!r.ok) throw new Error('net'); return await r.json();
      }catch(e){ return {status:'error', message:e.toString()}; }
    }
  };

  /* ===== BALANCES ===== */
  const updateWalletBalance = (walletId, amount, type, subName, isSource=true) => {
    const w = wallets.find(x=>x.id===walletId); if(!w) return;
    if (type==='transfer') return;
    if (type==='asset' && subName==='Loan Received Back'){ w.balance += amount; return; }
    if (type==='liability' && subName==='Loan Repaid'){ w.balance -= amount; return; }
    if (isSource){
      if (['expense','asset','liability'].includes(type)) w.balance -= amount;
      if (type==='income') w.balance += amount;
    }else{
      if (type==='asset') w.balance += amount;
      if (type==='liability') w.balance -= amount;
    }
  };
  const reverseWalletBalance = (t) => {
    const w = wallets.find(x=>x.id===t.walletId);
    const c = categories.find(x=>x.id===t.categoryId);
    const s = subcategories.find(x=>x.id===t.subcategoryId);
    if(!c) return;
    if (c.type==='transfer'){
      const toW = wallets.find(x=>x.id===t.toWalletId);
      if(w) w.balance += t.amount; if(toW) toW.balance -= t.amount; return;
    }
    if (c.type==='asset' && s?.name==='Loan Received Back'){ if(w) w.balance -= t.amount; return; }
    if (c.type==='liability' && s?.name==='Loan Repaid'){ if(w) w.balance += t.amount; return; }
    if (['expense','asset','liability'].includes(c.type)){ if(w) w.balance += t.amount; }
    if (c.type==='income'){ if(w) w.balance -= t.amount; }
  };

  /* ===== RENDER ===== */
  const renderWallets = () => {
    walletsGrid.innerHTML = ''; walletSelect.innerHTML = ''; editWalletSelect.innerHTML=''; toWalletSelect.innerHTML=''; editToWalletSelect.innerHTML='';
    wallets.forEach(w=>{
      const card = document.createElement('div');
      card.className = 'glass neon wallet tilt';
      card.innerHTML = `<h4>${w.name}</h4><p>‡ß≥${(w.balance||0).toFixed(2)}</p>`;
      walletsGrid.appendChild(card);
      const opt = new Option(w.name, w.id);
      walletSelect.add(opt.cloneNode(true)); editWalletSelect.add(opt.cloneNode(true));
      toWalletSelect.add(opt.cloneNode(true)); editToWalletSelect.add(opt.cloneNode(true));
    });
    const add = document.createElement('div');
    add.className = 'glass wallet add tilt';
    add.innerHTML = `<h4>+ Add Wallet</h4><p>Create a new wallet</p>`;
    add.onclick = ()=>{ const name = prompt('Enter new wallet name:'); if(name) addWallet(name); };
    walletsGrid.appendChild(add);
  };

  const renderCategories = () => {
    categoryList.innerHTML = '';
    categories.forEach(cat=>{
      const li = document.createElement('li'); li.className = 'glass neon txn';
      const subs = subcategories.filter(s=> s.categoryId===cat.id);
      li.innerHTML = `
        <div class="row" style="padding:14px 14px 10px; border-bottom:1px solid var(--border)">
          <div><strong>${cat.name}</strong> <span style="color:var(--muted)">(${cat.type})</span></div>
          <div>
            <button class="btn small" data-editcat="${cat.id}">Edit</button>
            <button class="btn small d" data-delcat="${cat.id}">Delete</button>
          </div>
        </div>
        <div style="padding:8px 10px 12px">
          ${subs.length ? subs.map(s=>`
            <div class="row" style="padding:8px 6px; border-bottom:1px dashed var(--border)">
              <span>${s.name}</span>
              <div>
                <button class="btn small" data-editsub="${s.id}">Edit</button>
                <button class="btn small d" data-delsub="${s.id}">Delete</button>
              </div>
            </div>`).join('') : `<div style="color:var(--muted); font-style:italic; padding:10px 6px">No subcategories yet.</div>`}
          <button class="btn small" data-addsub="${cat.id}">+ Add Subcategory</button>
        </div>
      `;
      categoryList.appendChild(li);
    });
  };

  const populateCategoryDropdowns = () => {
    categorySelect.innerHTML=''; editCategorySelect.innerHTML=''; categorySearchSelect.innerHTML='<option value="all">All Categories</option>';
    categories.forEach(c=>{
      categorySelect.add(new Option(c.name, c.id));
      editCategorySelect.add(new Option(c.name, c.id));
      categorySearchSelect.add(new Option(c.name, c.id));
    });
  };
  const updateSubcategoryDropdown = (categoryId, target) => {
    const subs = subcategories.filter(s => s.categoryId == categoryId);
    target.innerHTML = ''; subs.forEach(s=> target.add(new Option(s.name, s.id)));
  };

  const renderSummary = () => {
    let income=0, expense=0, lent=0, borrowed=0, savings=0, lentBack=0, borrowedPaid=0;
    transactions.forEach(t=>{
      const c = categories.find(x=>x.id===t.categoryId); if(!c) return;
      const s = subcategories.find(x=>x.id===t.subcategoryId);
      const a = t.amount, sn = s?.name || '';
      if (c.type==='income') income += a;
      if (c.type==='expense'){ expense += a; if(c.name==='Savings / Investments') savings += a; }
      if (c.type==='asset'){ if(sn==='Lent Money') lent += a; if(sn==='Loan Received Back') lentBack += a; }
      if (c.type==='liability'){ if(sn==='Borrowed Money') borrowed += a; if(sn==='Loan Repaid') borrowedPaid += a; }
    });
    const walletBal = wallets.reduce((s,w)=> s + (w.balance||0), 0);
    const net = walletBal - (borrowed - borrowedPaid);
    $('#totalIncome').textContent = `‡ß≥${income.toFixed(2)}`;
    $('#totalExpense').textContent = `‡ß≥${expense.toFixed(2)}`;
    $('#totalLent').textContent = `‡ß≥${(lent - lentBack).toFixed(2)}`;
    $('#totalBorrowed').textContent = `‡ß≥${(borrowed - borrowedPaid).toFixed(2)}`;
    $('#netWorth').textContent = `‡ß≥${net.toFixed(2)}`;
    $('#totalSavings').textContent = `‡ß≥${savings.toFixed(2)}`;
  };

  const renderCharts = () => {
    const expenseData = {}; const monthly = {};
    transactions.forEach(t=>{
      const c = categories.find(x=>x.id===t.categoryId); if(!c) return;
      const s = subcategories.find(x=>x.id===t.subcategoryId);
      const label = s ? s.name : c.name;
      const m = new Date(t.date).toLocaleDateString('en-US',{year:'numeric', month:'short'});
      if(c.type==='expense') expenseData[label] = (expenseData[label]||0) + t.amount;
      if(!monthly[m]) monthly[m] = {income:0, expense:0};
      if(c.type==='income') monthly[m].income += t.amount;
      if(c.type==='expense') monthly[m].expense += t.amount;
    });

    const pieCtx = document.getElementById('expensePieChart').getContext('2d');
    if (expensePieChart) expensePieChart.destroy();
    expensePieChart = new Chart(pieCtx, {
      type:'pie',
      data:{ labels:Object.keys(expenseData),
        datasets:[{ data:Object.values(expenseData),
          backgroundColor:['#06b6d4','#a855f7','#ef4444','#f59e0b','#22c55e','#e11d48'] }]},
      options:{responsive:true, plugins:{legend:{position:'top'}, title:{display:true,text:'Expense Breakdown'}}}
    });

    const barCtx = document.getElementById('incomeExpenseBarChart').getContext('2d');
    if (incomeExpenseBarChart) incomeExpenseBarChart.destroy();
    const months = Object.keys(monthly).sort((a,b)=> new Date(a) - new Date(b));
    incomeExpenseBarChart = new Chart(barCtx,{
      type:'bar',
      data:{
        labels:months,
        datasets:[
          {label:'Income', data: months.map(m=>monthly[m].income), backgroundColor:'rgba(34,197,94,.7)', borderColor:'#22c55e', borderWidth:1},
          {label:'Expense', data: months.map(m=>monthly[m].expense), backgroundColor:'rgba(239,68,68,.7)', borderColor:'#ef4444', borderWidth:1}
        ]
      },
      options:{responsive:true, scales:{y:{beginAtZero:true}}, plugins:{legend:{position:'top'}, title:{display:true, text:'Income vs Expense'}}}
    });
  };

  const typeClass = t => t==='transfer'?'tr': t==='income'?'in': t==='expense'?'ex': t==='asset'?'as': t==='liability'?'li':'';
  const typeSign  = t => t==='transfer' ? '‚ÜîÔ∏è' : (['expense','asset','liability'].includes(t) ? '-' : '+');

  const renderTransactions = (arr = transactions) => {
    transactionList.innerHTML = '';
    const list = [...arr].sort((a,b)=> new Date(b.date) - new Date(a.date));
    if(!list.length){ transactionList.innerHTML = `<li class="glass neon txn"><div class="meta">No transactions found.</div></li>`; return; }
    list.forEach(t=>{
      const w = wallets.find(x=>x.id==t.walletId), c = categories.find(x=>x.id==t.categoryId), s = subcategories.find(x=>x.id==t.subcategoryId);
      const klass = typeClass(c ? c.type : 'expense'), sign = typeSign(c ? c.type : 'expense');
      const d = new Date(t.date).toLocaleDateString(undefined,{year:'numeric', month:'short', day:'numeric'});
      const li = document.createElement('li'); li.className='glass neon txn tilt';
      li.innerHTML = `
        <div class="row">
          <div style="flex:1">
            <div style="font-weight:900">${t.description}</div>
            <div class="meta">${d} ‚Ä¢ ${(w?w.name:'N/A')} ‚Ä¢ ${(c?c.name:'N/A')} ‚Üí ${(s?s.name:'N/A')}</div>
          </div>
          <div class="amt ${klass}">${sign}‡ß≥${t.amount.toFixed(2)}</div>
        </div>
        <div class="row" style="margin-top:8px; justify-content:flex-end; gap:6px">
          <button class="icon-btn" data-edit="${t.id}">‚úèÔ∏è</button>
          <button class="icon-btn" data-del="${t.id}" title="Delete">üóëÔ∏è</button>
        </div>`;
      transactionList.appendChild(li);
    });
  };

  const renderAll = () => { renderWallets(); renderSummary(); renderTransactions(); renderCharts(); };

  /* ===== CRUD + FORMS ===== */
  const addWallet = async (name) => {
    if (wallets.some(w => w.name.toLowerCase()===name.toLowerCase())){ alert('A wallet with this name already exists.'); return; }
    wallets.push({id: Date.now(), name, balance:0});
    await api.save({wallets, categories, subcategories, transactions});
    renderWallets(); showToast('Wallet added','ok');
  };
  const addCategory = async () => {
    const name = $('#newCategoryName').value.trim(); const type = $('#newCategoryType').value; if(!name) return;
    categories.push({id: Date.now(), name, type});
    await api.save({wallets, categories, subcategories, transactions});
    renderCategories(); populateCategoryDropdowns(); $('#newCategoryName').value=''; showToast('Category added','ok');
  };
  const addSubcategory = async (categoryId, name) => {
    subcategories.push({id: Date.now(), name, categoryId});
    await api.save({wallets, categories, subcategories, transactions});
    renderCategories(); showToast('Subcategory added','ok');
  };
  const deleteCategory = async (id) => {
    subcategories = subcategories.filter(s => s.categoryId !== id);
    categories = categories.filter(c => c.id !== id);
    await api.save({wallets, categories, subcategories, transactions});
    renderCategories(); populateCategoryDropdowns(); showToast('Category deleted','ok');
  };
  const deleteSubcategory = async (id) => {
    subcategories = subcategories.filter(s => s.id !== id);
    await api.save({wallets, categories, subcategories, transactions});
    renderCategories(); showToast('Subcategory deleted','ok');
  };
  const editCategoryFn = async (id, name, type) => {
    const c = categories.find(x=>x.id===id); if(!c) return; c.name=name; c.type=type;
    await api.save({wallets, categories, subcategories, transactions});
    renderCategories(); populateCategoryDropdowns(); showToast('Category updated','ok');
  };
  const editSubcategoryFn = async (id, name) => {
    const s = subcategories.find(x=>x.id===id); if(!s) return; s.name=name;
    await api.save({wallets, categories, subcategories, transactions});
    renderCategories(); populateCategoryDropdowns(); showToast('Subcategory updated','ok');
  };

  const addTransaction = async (e) => {
    e.preventDefault();
    const description = $('#description').value.trim();
    const amount = parseFloat($('#amount').value);
    const date = $('#transactionDate').value;
    const walletId = parseInt($('#wallet').value);
    const categoryId = parseInt($('#category').value);
    const subcategoryId = parseInt($('#subcategory').value);
    const c = categories.find(x=>x.id===categoryId);
    const s = subcategories.find(x=>x.id===subcategoryId);

    let t = {id: Date.now(), description, amount, date, walletId, categoryId, subcategoryId};

    if(c.type==='transfer'){
      const toWalletId = parseInt($('#toWallet').value);
      if(walletId === toWalletId){ alert('Cannot transfer to the same wallet.'); return; }
      t.toWalletId = toWalletId;
      const fromW = wallets.find(w=>w.id===walletId);
      const toW = wallets.find(w=>w.id===toWalletId);
      if(fromW) fromW.balance -= amount; if(toW) toW.balance += amount;
    }else{
      updateWalletBalance(walletId, amount, c.type, s ? s.name : '');
    }

    transactions.push(t);
    await api.save({wallets, categories, subcategories, transactions});
    renderAll(); form.reset(); $('#transactionDate').value = new Date().toISOString().split('T')[0];
    transferFields.style.display='none'; switchView('v-history'); showToast('Transaction added','ok');
  };

  const showEditModal = (id) => {
    const t = transactions.find(x=>x.id===id); if(!t) return;
    $('#editId').value = t.id;
    $('#editDescription').value = t.description;
    $('#editAmount').value = t.amount;
    $('#editTransactionDate').value = t.date;
    $('#editWallet').value = t.walletId;
    $('#editCategory').value = t.categoryId;
    updateSubcategoryDropdown(t.categoryId, editSubcategorySelect);
    $('#editSubcategory').value = t.subcategoryId;

    const c = categories.find(x=>x.id===t.categoryId);
    if(c && c.type==='transfer'){ editTransferFields.style.display = 'block'; $('#editToWallet').value = t.toWalletId; }
    else{ editTransferFields.style.display = 'none'; }
    showModal('editModal');
  };

  const updateTransaction = async (e) => {
    e.preventDefault();
    const id = parseInt($('#editId').value);
    const t = transactions.find(x=>x.id===id); if(!t) return;

    reverseWalletBalance(t);

    t.description = $('#editDescription').value.trim();
    t.amount = parseFloat($('#editAmount').value);
    t.date = $('#editTransactionDate').value;
    t.walletId = parseInt($('#editWallet').value);
    t.categoryId = parseInt($('#editCategory').value);
    t.subcategoryId = parseInt($('#editSubcategory').value);

    const c = categories.find(x=>x.id===t.categoryId);
    const s = subcategories.find(x=>x.id===t.subcategoryId);

    if(c.type==='transfer'){
      t.toWalletId = parseInt($('#editToWallet').value);
      const fromW = wallets.find(w=>w.id===t.walletId);
      const toW = wallets.find(w=>w.id===t.toWalletId);
      if(fromW) fromW.balance -= t.amount; if(toW) toW.balance += t.amount;
    }else{
      updateWalletBalance(t.walletId, t.amount, c.type, s ? s.name : '');
    }

    await api.save({wallets, categories, subcategories, transactions});
    renderAll(); hideModal('editModal'); showToast('Changes saved','ok');
  };

  /* ===== CSV ===== */
  const downloadCSV = (rows) => {
    const headers = ['Date','Description','Amount','Wallet','Category','Subcategory'];
    const lines = [headers.join(',')].concat(rows.map(t=>{
      const w = wallets.find(x=>x.id==t.walletId);
      const c = categories.find(x=>x.id==t.categoryId);
      const s = subcategories.find(x=>x.id==t.subcategoryId);
      return [
        t.date,
        `"${t.description.replace(/"/g,'""')}"`,
        t.amount,
        `"${w ? w.name : 'N/A'}"`,
        `"${c ? c.name : 'N/A'}"`,
        `"${s ? s.name : 'N/A'}"`
      ].join(',');
    }));
    const blob = new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = `transactions_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
  };

  /* ===== BACKUP / RESTORE ===== */
  const handleBackup = async () => {
    backupBtn.disabled = true; backupBtn.textContent = 'Creating Backup...';
    const r = await api.callScript('backupToDrive');
    backupBtn.disabled = false; backupBtn.textContent = '‚¨ÜÔ∏è Backup to Drive';
    (r.status==='success') ? showToast(r.message||'Backup complete','ok') : showToast('Backup failed','err');
  };
  const handleListBackups = async () => {
    listBackupsBtn.disabled = true; listBackupsBtn.textContent = 'Loading...';
    const r = await api.callScript('listBackupFiles');
    listBackupsBtn.disabled = false; listBackupsBtn.textContent = 'üìÑ List Backups';
    restoreFileSelect.innerHTML = '<option value="">-- Select a file --</option>'; restoreSection.style.display='block';
    if(r.status==='success' && Array.isArray(r.files) && r.files.length) r.files.forEach(f=> restoreFileSelect.add(new Option(f.name, f.id)));
    else restoreFileSelect.innerHTML = '<option value="">No backups found</option>';
  };
  const handleRestore = async () => {
    const fid = restoreFileSelect.value; if(!fid){ alert('Please select a backup file to restore.'); return; }
    if(!confirm('WARNING: This will overwrite ALL your current data. Continue?')) return;
    restoreBtn.disabled = true; restoreBtn.textContent = 'Restoring...';
    const r = await api.callScript('restoreFromDrive', {fileId: fid});
    restoreBtn.disabled = false; restoreBtn.textContent = '‚¨áÔ∏è Restore Selected';
    if(r.status==='success'){
      showToast(r.message||'Restore complete','ok');
      const data = await api.load();
      wallets = data.wallets; categories = data.categories; subcategories = data.subcategories; transactions = data.transactions;
      renderAll(); renderCategories(); populateCategoryDropdowns();
    }else showToast('Restore failed','err');
  };

  /* ===== MODALS ===== */
  const showModal = id => document.getElementById(id).classList.add('show');
  const hideModal = id => document.getElementById(id).classList.remove('show');
  const closeModalBtns = $$('.close[data-target], .modal .btn[data-target]');
  closeModalBtns.forEach(b=> b.addEventListener('click', ()=> hideModal(b.getAttribute('data-target'))));
  window.addEventListener('click', e => { if(e.target.classList?.contains('modal')) e.target.classList.remove('show'); });

  /* ===== EVENTS ===== */
  form.addEventListener('submit', addTransaction);
  editForm.addEventListener('submit', updateTransaction);
  $('#addCategoryBtn').addEventListener('click', addCategory);
  categoryList.addEventListener('click', e=>{
    const editCat = e.target.getAttribute('data-editcat');
    const delCat  = e.target.getAttribute('data-delcat');
    const addSub  = e.target.getAttribute('data-addsub');
    const editSub = e.target.getAttribute('data-editsub');
    const delSub  = e.target.getAttribute('data-delsub');
    if(editCat){
      const c = categories.find(x=>x.id==editCat);
      if(c){ $('#editCategoryId').value=c.id; $('#editCategoryName').value=c.name; $('#editCategoryType').value=c.type; showModal('editCategoryModal'); }
    }else if(delCat){
      const id = parseInt(delCat);
      $('#deleteConfirmMessage').textContent='Delete this category and all its subcategories?';
      deleteCallback = ()=> deleteCategory(id); showModal('deleteConfirmModal');
    }else if(addSub){
      currentCategoryIdForSubcategory = parseInt(addSub);
      $('#newSubcategoryName').value=''; showModal('addSubcategoryModal');
    }else if(editSub){
      const s = subcategories.find(x=>x.id==editSub);
      if(s){ $('#editSubcategoryId').value=s.id; $('#editSubcategoryName').value=s.name; showModal('editSubcategoryModal'); }
    }else if(delSub){
      const id = parseInt(delSub);
      $('#deleteConfirmMessage').textContent='Delete this subcategory?';
      deleteCallback = ()=> deleteSubcategory(id); showModal('deleteConfirmModal');
    }
  });
  $('#saveSubcategoryBtn').addEventListener('click', ()=>{
    const name = $('#newSubcategoryName').value.trim(); if(!name) return;
    addSubcategory(currentCategoryIdForSubcategory, name); hideModal('addSubcategoryModal');
  });
  $('#saveCategoryChangesBtn').addEventListener('click', ()=>{
    const id = parseInt($('#editCategoryId').value);
    const name = $('#editCategoryName').value.trim();
    const type = $('#editCategoryType').value;
    if(!name) return; editCategoryFn(id,name,type); hideModal('editCategoryModal');
  });
  $('#saveSubcategoryChangesBtn').addEventListener('click', ()=>{
    const id = parseInt($('#editSubcategoryId').value);
    const name = $('#editSubcategoryName').value.trim();
    if(!name) return; editSubcategoryFn(id,name); hideModal('editSubcategoryModal');
  });
  $('#confirmDeleteBtn').addEventListener('click', ()=>{ if(deleteCallback) deleteCallback(); hideModal('deleteConfirmModal'); });

  categorySelect.addEventListener('change', ()=>{
    const c = categories.find(x=>x.id==categorySelect.value);
    transferFields.style.display = (c && c.type==='transfer') ? 'block' : 'none';
    updateSubcategoryDropdown(categorySelect.value, subcategorySelect);
  });
  editCategorySelect.addEventListener('change', ()=>{
    const c = categories.find(x=>x.id==editCategorySelect.value);
    editTransferFields.style.display = (c && c.type==='transfer') ? 'block' : 'none';
    updateSubcategoryDropdown(editCategorySelect.value, editSubcategorySelect);
  });

  categorySearchSelect.addEventListener('change', e=>{
    const id = e.target.value;
    if(id==='all') renderTransactions(); else renderTransactions(transactions.filter(t=> t.categoryId == id));
  });
  downloadCsvBtn.addEventListener('click', ()=>{
    const id = categorySearchSelect.value;
    const rows = id==='all' ? transactions : transactions.filter(t=> t.categoryId == id);
    downloadCSV(rows);
  });

  backupBtn.addEventListener('click', handleBackup);
  listBackupsBtn.addEventListener('click', handleListBackups);
  restoreFileSelect.addEventListener('change', ()=> restoreBtn.disabled = !restoreFileSelect.value);
  restoreBtn.addEventListener('click', handleRestore);

  /* ===== INIT ===== */
  const data = await api.load();
  wallets = data.wallets; categories = data.categories; subcategories = data.subcategories; transactions = data.transactions;
  $('#transactionDate').value = new Date().toISOString().split('T')[0];
  renderAll(); renderCategories(); populateCategoryDropdowns(); updateSubcategoryDropdown(categorySelect.value, subcategorySelect);
});
</script>
</body>
</html>
